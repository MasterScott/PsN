\input{inputs/format_header.tex}
\guidetitle{Bootstrap user guide}
\begin{document}
%revision 2014-05-16 Kajsa

\maketitle


\section{Introduction}

Bootstrap is a tool for calculating bias, standard errors and confidence intervals of parameter estimates. It does so by generating a set of new datasets by sampling individuals with replacement from the original dataset, and fitting the model to each new dataset \cite{Efron}. 
Examples:
\begin{verbatim}
bootstrap moxonidine.mod -samples=100
bootstrap pheno.mod -samples=500 -seed=12345 -threads=5
\end{verbatim}

\section{Input and options}

\subsection{Bootstrap-specific input}
A model file is required on the command-line.

\begin{optionlist}
\optdefault{samples}{N}
The number of bootstrapped datasets to generate. Default is 200. 
\nextopt
\optdefault{sample\_size}{M}
The number of subjects in each bootstrap data set. The default       value is set to the number of individuals in the original data set. When the resampling is stratified, the sample\_size option can be used to specify the exact number of samples that should be drawn from each strata. Below follows an example of the syntax that should be used in such a case. Stratification is here done based on the study number, STUD, with the values 1001, 1002 and 1003.  -sample\_size='1001$=>$12,1002$=>$24,1003$=>$10'                          This example specifies that the bootstrap should use 12 samples from study 1001, 24 samples from 1002 and 10 from study 1003. If only one sample size is used together with stratified resampling (the default case; sample\_size=number of individuals in the data set), the strata are assigned samples in proportion to their size in the data set. Please note that this usage of the sample\_size option does not guarantee that the sum of the samples of the strata is equal to the given sample\_size since PsN needs to round the figures to the closest integer. For a sample size equal to the number of individuals in the data set, the sum will however always be correct. 
\nextopt
\optdefault{stratify\_on}{column name}
It may be necessary to use stratification in the resampling procedure. For example, if the original data consists of two groups of patients - say 10 patients with full pharmacokinetic profiles and 90 patients with sparse steady state concentration measurements - it may be wise to restrict the resampling procedure to resample within the two groups, producing bootstrap data sets that all contain 10 rich + 90 sparse data patients but with different compositions. The default is not to use stratification. Set -stratify\_on to the column (the name in \$INPUT) that defines the two groups. Note that the option sample\_size has a different behaviour when stratified resampling is used. 

Bootstrapping is always done on entire individuals, so for each ID the data records are either all included or all excluded from a particular bootstrapped data set.
The algorithm requires that an individual can unambigously be categorized according to the stratification variable. 
In data file terms, it means that the variable used for stratification must have one and only one value for each individual, otherwise the program will stop with an error message saying that at least one individual has multiple values
in the stratification column, and therefore this column cannot be used for stratification of the resampling.
\nextopt
\optname{keep\_tables}
By default, all \$TABLE will be deleted from the bootstrap models, to save disk space. If option -keep\_tables is set, 
PsN will instead keep \$TABLE, which can require much disk space.
\nextopt
\optname{bca}
Default not used. When used, the bootstrap utility will calculate the confidence intervals through the BCa method \cite{Efron}. The BCa is intended for calculation of second-order correct confidence intervals. Warning: Using bca is very time-consuming. 
\nextopt
\optname{skip\_minimization\_terminated}
Used by default. When used, the bootstrap will skip all samples where the NONMEM run terminated the minimization step. Disable with -no-skip\_minimization\_terminated. 
\nextopt
\optname{skip\_covariance\_step\_terminated}
Default not used. When true/used, the bootstrap will skip all samples where the NONMEM run terminated the covariance step. 
\nextopt
\optname{skip\_with\_covstep\_warnings}
Default not used. When used the bootstrap will skip all samples where the NONMEM run had warnings from the covariance step. 
\nextopt
\optname{skip\_estimate\_near\_boundary}
Default not used. When used, the bootstrap will skip all samples where the NONMEM run signal that some estimates are near its boundary. 
\nextopt
\optname{allow\_ignore\_id}
Default not used. When not used, i.e. by default, bootstrap will print a message and terminate if an IGNORE or ACCEPT statement based on the ID column is found in the \$DATA record. This is done because it would interfere with the internal renumbering of individuals that the script does, producing errors. If -allow\_ignore\_id is used (not recommended), a warning is printed but the program continues execution. Note: The IGNORE statement can safely be used in conjunction with any other column than ID. 
\nextopt
\optname{copy\_data}
Default set. If option is set, the original data file
will be copied to the run directory if the input model is to be run.
If option is unset using -no-copy\_data, the absolute path to the original data file will be used in
\$DATA when the input model is run, and the data file will not be copied. This saves disk space.
\nextopt
\optname{dofv}
Optional, default not used. Evaluate original data with bootstrap parameter estimates and compute delta-ofv. See section Computing delta-ofv. 
\nextopt
\optdefault{mceta}{N}
Optional, default not used. If option -dofv is set and NM version 7.3 or later is used, setting this option will make PsN set MCETA=N in \$ESTIMATION. It is up to the user to check that the estimation method used can in NONMEM be combined with option MCETA, PsN will not do that. 
\nextopt
\end{optionlist}


\subsection{Some common PsN-options useful with bootstrap}

For a complete list of common options see common\_options\_defaults\_versions.pdf, or psn\_options -h on the commandline.

\begin{optionlist}
\optdefault{directory}{bootstrap\_dirN}
The directory in which the script will run NONMEM can be named. The default name is “bootstrap\_dirN” where N is increased by 1 each time you run the script. If the run is aborted or crashes, setting the directory to the one from which the script was running earlier can be done. PsN will then not run the model files that had finished, saving time. 
\nextopt
\optdefault{seed}{string}
A seed for the random number generator can be specified. This makes the run reproducible. Important note: the results of two runs will be different even if the seed is the same if the lst-file of the base model is present at the start of one run but not the other. Running the base model changes the state of the random number generator, and therefore the bootstrapped datasets will be different depending on if the base model is run or not before generating the  new datasets. 
\nextopt
\optdefault{clean}{N}
The user may choose to remove different sets of intermediate file by setting clean to 3, 2, 1, or 0. The higher the number the more files are removed. 
\nextopt
\optdefault{threads}{N}
The number of parallel processes to start on a parallel computer. 
\nextopt
\optname{help}
With -help bootstrap will print a longer help message. 
\nextopt
\end{optionlist}


\section{Output}

The file bootstrap\_results.csv contains statistics and summaries specific for the bootstrap.

The raw\_results1.csv file is a standard PsN file containing raw result data for termination status, parameter estimates, uncertainty estimates etc. for all model estimations. The first row is for the original dataset.

A file delta\_ofv.csv is created if option -dofv is set, see section Computing delta-ofv.

included\_individuals1.csv: One row per bootstrapped dataset. Each row consists of the ID:s of the individuals in that dataset. Note that different individuals may have the same ID number in a NONMEM dataset. The numbers appear in the order the individuals appear in the datafile.

included\_keys1.csv: One row per bootstrapped dataset. Each row consists of the internal and unique order numbers (1-N) of the individuals in that dataset. The numbers appear in the order the individuals appear in the bootstrapped dataset. 

sample\_keys1.csv:  One row per bootstrapped dataset. Each row consists of one number C per individual in the dataset, in the order the individuals appear in the original datafile, where C is the number of times the individual is included in the bootstrapped dataset. 

The row order is consistent between the files raw\_results, included\_individuals, included\_keys and sample\_keys so that row j (excluding headers if any) in each of the files concerns the same bootstrapped dataset.

\section{Known bugs and problems}

It is recommended to remove PRINT options from \$ESTIMATION, to save disk space.

PsN renumbers the individuals during bootstrapping. Therefore ACCEPT/IGNORE statements based on ID will cause errors. 
There is an input check for this, but it is recommended to not rely on this check. Also, model code that relies on ID numbers will also lead to
errors.

The results of two runs will be different even if the seed is the same if the lst-file of the base model is present at the start of one run but not the other. Running the base model changes the state of the random number generator, and therefore the bootstrapped datasets will be different depending on if the base model is run or not before generating the  new datasets. 

\section{Technical overview of algorithm}

PsN will rerun the base model if the lst-file of the input model (run1.lst if the input model file is called run1.mod) is not present in the same directory as the model file OR if the model file has a different extension than .mod, for example .ctl. If the model file has the extension .mod and the lst-file is present then PsN will simply read the estimates from that file.

The program creates N (N=number of samples), datasets of size M (M=sample\_size) by randomly drawing individuals with replacement from the original dataset. The program creates N new NONMEM modelfiles which are identical to the original modelfile with the exception that each uses a different  bootstrapped dataset and that the initial parameter estimates are the final estimates from the original run. The model parameters are estimated with each dataset, including the original, resulting in N+1 estimates for each parameter.

\section{Computing delta-ofv}

If option -dofv is set, PsN will perform a MAXEVAL=0 run for each set of bootstrap parameter estimates using the original model and data. This is done after all other runs and computations are completed, including any Bca step. The results will be printed to a csv file called delta\_ofv.csv where the first column is bootstrap data id and the second delta-ofv which is computed as 
$\mathrm{ofv}_{bs,maxev=0}$ – $\mathrm{ofv}_{original}$. If option -mceta=N is set and NM7.3 or later is used and the estimation method is classical then option MCETA=N will be set in \$ESTIMATION. There will be up to 200 \$PROBLEMs defined in each model file (control stream) to reduce PsN overhead when calling NONMEM.

It is possible to restart a previously run bootstrap to compute delta-ofv without rerunning all bootstrap estimations, provided that option -clean was set to 2 or less in the original run. Simply run bootstrap again with option -directory set to the existing run directory. PsN will intiate reruns of all bootstrap samples, but reread existing output instead of really starting NONMEM. Then the delta-ofv models will be run. If option -bca was set in the original bootstrap run it is important to set -bca also in the restart, otherwise the jackknife results will be overwritten. 

\section{Recovering a crashed bootstrap}

All the modelfiles and bootstrapped dataset are in the m1 subdirectory. Models that have finished will also have a lst-file. The lst-files have been copied from the NM\_run directories in the modelfit\_dir  subdirectory.  
If there is a computer crash in the middle of a long bootstrap, you can still use the samples that did finish. 
\begin{enumerate}
	\item In NM\_run directories of modelfit\_dir subdirectory, remove the lst-files (all files ending with .lst) from crashed NONMEM runs.
	\item Rerun same command (command.txt) with same -seed (check in version\_and\_option\_info.txt) and add option -directory=$\langle$name\_of\_old\_directory$\rangle$. PsN will see that some models finish and only rerun the ones with missing lst-files. 
\end{enumerate}
If some samples terminated due to e.g. rounding errors but most of the samples finish okay: 
\begin{enumerate}
	\item Go to the m1 subdirectory and run execute with -retries option on the model that did not finish. 
	\item After models in m1 have run, use the rawresults script (see rawresults -help) to create a summary of all parameter estimates. Open output file from rawresults in Excel and do statistics manually. 
\end{enumerate}
If too many samples were discarded due to e.g. minimization terminated and you wish you had set  option -no-skip\_minimization\_terminated: Open raw\_results.csv in Excel and do statistics manually. 


\begin{thebibliography}{1}
\bibitem{Efron} Efron B, {\em An Introduction to the Bootstrap}, Chap. \& Hall, London UK, 1993
\end{thebibliography}

\end{document}

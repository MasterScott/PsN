\input{inputs/format_header.tex}
\guidetitle{Developer's guide}
\usepackage{hyperref}

\begin{document}

\maketitle

  
\section{Introduction}

This document is intended for PsN developers. It is work in progress.
\section{Installing a non-public version of PsN for running and testing}
\begin{itemize}
\item Install git \cite{git}. 
\item Do git clone in a suitable place on your computer.
\begin{verbatim}
git clone git://git.code.sf.net/p/psn/PsN4 PsN4
\end{verbatim}
\item Change directory to PsN4.
\begin{verbatim}
cd PsN4
\end{verbatim}
\item Run commands 
\begin{verbatim}
make clean
make release
\end{verbatim}
\noindent which gives you a directory PsN-Source.
\item Change directory to PsN-Source.
\begin{verbatim}
cd PsN-Source
\end{verbatim}
\item Run the setup script, as you would with if you had downloaded an installation package from psn.sf.net
\begin{verbatim}
perl setup.pl
\end{verbatim}
\item To be able to run the tests in PsN4/test on the PsN version you just installed, you need to edit PsN4/test/includes.pm to set the right use lib statements. The includes.pm file is currently needed to run tests on non-default PsN versions on a system where multiple versions of PsN are installed. 
\end{itemize}

\section{Installing development version of PsN to make contributions to the code}
\begin{itemize}
\item Install git \cite{git}. 
\item Do git clone in a suitable place on your computer, and checkout a suitable branch. On linux:
\begin{verbatim}
cd ~
git clone git://git.code.sf.net/p/psn/PsN4 PsN4
git checkout -b NLP origin/NLP 

\end{verbatim}
\noindent Then do the following (assuming linux):
\item Add the PsN4/bin directory to your \$PATH variable, so that you can call PsN scripts without including the path.
\item Copy the file PsN4/lib/PsN\_template.pm to PsN4/lib/PsN.pm. Open PsN.pm and add the following lines at the very top, before
use ext::Carp (of course change paths from /home/kajsa/kod-psn/ to what you have):
\begin{verbatim}
package PsN;
use lib '/home/kajsa/kod-psn/PsN4/lib';
$lib_dir = '/home/kajsa/kod-psn/PsN4/lib';
$config_file = '/home/kajsa/psn.conf';
$version = 'development';
\end{verbatim} 
Save and close PsN.pm
\item Unless you already have a psn.conf file in the location set in PsN.pm, put one there. 
You can use PsN4/lib/psn.conf\_template as a template and just fill in the [nm\_version] section,
according to psn\_configuration.pdf.
\item Make sure you have the required Perl modules listed in PsN4/README.txt installed.
\item To be able to run the tests in PsN4/test you need to edit PsN4/test/includes.pm to set the right use statements for your user. 
\item To be able to push your changes on the git server you need create a SourceForge account, 
and then ask the PsN team to give you permission to push on PsN4.
Stay on the NLP branch so that git pull and git push will be on that branch. 
\end{itemize}


\section{Testing}
The PsN4/test directory contains the tests. Unit tests are in PsN4/test/unit and system tests in PsN4/test/system. When installing PsN the user has the option to install the test suite in a specified directory. The default directory is in the lib directory. To be able to run the tests the package Test::Exception has to be installed on some systems. 
Unit tests are defined as tests that do not involve \emph{running} NONMEM, while system tests are tests involving running NONMEM. 
Tests can be run by using the command \verb|prove| (which is bundled with perl). The unit tests can be run by issuing the command
\begin{verbatim}
prove -r unit
\end{verbatim}
and the system tests can be run with
\begin{verbatim}
prove -r system
\end{verbatim}

Test can be run from any directory given a path to prove:
\begin{verbatim}
prove -r PsN4/test/unit
\end{verbatim}

Individual test scripts can be run with e.g. 
\begin{verbatim}
prove bootstrap.t
\end{verbatim}

It is possible to run multiple tests in parallel to speed up the testing. This can be done with the option -j n to prove, where n is the number of parallel jobs e.g.
\begin{verbatim}
prove -j 4 -r system
\end{verbatim}

If the tests are to be run on a cluster a setup of a temporary directory that is reachable from all nodes is needed in includes.pm. Edit test/includes.pm and change the row that sets the \$tempdir to \$tempdir = <my path to an already created temporary directory that is reachable from all nodes>;

\section{Build environment}
The documentation is made in \LaTeX and pdfs can be generated with \verb|make doc|. The
packages texlive-extra-util and texlive-science are needed to build all documents.

\section{Revision control}
PsN use git as revision control system. This chapter give some best practices.

\subsection{Tagging}
All releases of PsN should be tagged with its version number with an annotated tag. Remember
that tags need to be pushed separately.
\begin{verbatim}
git tag -a 4.0.0 - m "My tag message"
git push origin --tags
\end{verbatim}

\section{Style guide}

\subsection{Object construction}

Remember the construction order in Moose. If we have a superclass called parent and a subclass called child and call \verb|child->new| the constructors will be executed in the following order:

\begin{enumerate}
	\item child->BUILDARGS
	\item parent->BUILDARGS
	\item Moose internal construction
	\item parent->BUILD
	\item child->BUILD
\end{enumerate}


\subsection{Methods}

\subsubsection{Parameter validation}
All methods should validate their parameters with validated\_hash in MooseX::Params::Validate

\begin{verbatim}
use MooseX::Params::Validate;

sub my_method
{
  my ($self, %parm) = validated_hash(@_,
    parameter1 => { isa => 'Str', optional => 0 },
    parameter2 => { isa => 'Num', default => '28' },
  );

  # ...
}
\end{verbatim}

See the MooseX::Params::Validate documentation \cite{params} and Moose::Types documentation \cite{types} for more information.

Remember to turn off the parameter caching if you give default values that can vary between calls.

\begin{verbatim}
my ($self, %parm) = validated_hash(@_,
  parameter1 => { isa => 'Str', optional => 0 },
  parameter2 => { isa => 'Num', default => $self->some_method },
  MX_PARAMS_VALIDATE_NO_CACHE => 1
);
\end{verbatim}

\subsubsection{Private methods}

Names of private methods should start with an underscore.
\begin{verbatim}
sub _this_is_a_private_method
{

}
\end{verbatim}


\subsection{Attributes}
triggers should be named \_attribute\_set
\begin{verbatim}
has 'filename' => (is => 'rw', isa => 'Str', trigger => \&_filename_set );

sub _filename_set
{
  my $self = shift;
  my $parm = shift;
  my $old_parm = shift;

	if ($parm ne $old_parm) {
    print "We are changing the filename!\n";
  }
}
\end{verbatim}

clearers should be named clear\_attribute
\begin{verbatim}
has 'filenames' => (is => 'rw', isa => 'ArrayRef[Str]', clearer => 'clear_filenames' );

if ($need_to_delete) {
  $self->clear_filenames;
}
\end{verbatim}

predicates should be named has\_attribute
\begin{verbatim}
has 'filename' => (is => 'rw', isa => 'Str', predicate => 'has_filename' );

if ($self->has_filename) {
  print "The filename attribute exists\n";
}
\end{verbatim}

\subsection{External modules}

As a workaround for a bug in the Carp package \verb|use include_modules;| should be used instead of \verb|use Carp;|. All the ordinary Carp methods will be exported.


\begin{thebibliography}{1}
	\bibitem{git} {\em Pro Git}, \url{http://git-scm.com/book}, Apress
	\bibitem{params} {\em MooseX::Params::Validate}, \url{http://search.cpan.org/\~drolsky/MooseX-Params-Validate-0.18/lib/MooseX/Params/Validate.pm}, CPAN
	\bibitem{types} {\em Moose::Manual::Types}, \url{http://search.cpan.org/~ether/Moose-2.1005/lib/Moose/Manual/Types.pod}, CPAN
\end{thebibliography}


\end{document}

\input{inputs/format_header.tex}
\guidetitle{SIR user guide}

\begin{document}

\maketitle


\section{Introduction}
Uncertainty on model parameters will be calculated for run0.mod using the Sampling Importance Resampling (SIR) procedure.
First, parameter vectors will be simulated from the truncated multivariate normal distribution given by the covariance matrix found in run0.cov
(alternatively, a file with simulated parameter vectors can be given directly as input and this simulation is skipped).
Second, each of the simulated parameter vectors will be evaluated on the original data (MAXEVAL=0).
Third, based on these evaluations, weights will be calculated for each of the parameter vectors and the vectors 
will be resampled according to these weights. Finally, the uncertainty covariance matrix of the parameters 
will be computed from the resampled parameter vectors.

Example
\begin{verbatim}
sir -samples=5000 -resamples=1000 run0.mod
\end{verbatim}

\section{Input and options}
A model file is required on the command-line.

\begin{optionlist}
\optdefault{samples}{N}
The number of parameter vectors to generate. Needs to be greater than the number of resamples. A good starting point may be 5 times the number of resamples.
\nextopt
\optdefault{resamples}{N}
The number of parameter vectors to resample based on the weights
computed from delta ofv and the pdf. Only these will be used to compute the uncertainty (confidence intervals) around the model parameters. A good strating point may be 1000 resamples.
\nextopt
\optdefault{mceta}{N}
Sets option MCETA=N in \$ESTIMATION. Only allowed with NM7.3 and classical estimation methods.
\nextopt
\optdefault{rawres\_input}{filename}
If rawres\_input is given, sir will take samples sets of parameter
vectors from this file, starting on line offset\_rawres+1, instead of
drawing samples from a truncated multivariate normal distribution 
based on the input model parameter estimates and 
covariance matrix.
The raw results file must contain at least as many 
samples as the input -samples to sir, the labels for  THETA/OMEGA/SIGMA 
in the file must match the labels in the model given as input 
to sir, the theta columns must be directly followed by the omega columns 
which must be directly followed by the sigma columns, and the first or
second column must have header model. Note that is is 
possible to generate a file with initial parameter estimates outside 
of PsN, as long as the file follows the format rules.
\nextopt
\optdefault{offset\_rawres}{N}
Default 1. The number of parameter sets to skip in rawres file. Only allowed in combination with rawres\_input.
\nextopt
\optdefault{in\_filter}{condition on numerical col}
Default not used. Only allowed in combination with rawres\_input.
\nextopt
\optname{with\_replacement}
Default not set. By default, resampling is performed without replacement, but setting this option gives resampling with replacement.
\nextopt
\optname{copy\_data}
Default not set. If option is not set, the data file will not be copied from the m1 directory to the NM\_run directories for NONMEM execution, which saves disk space. If -copy\_data is set, the data file will be copied to each NM\_run directory.
\nextopt
\optdefault{covmat\_input}{filename}
Only allowed together with rawres\_input. If given, this matrix is
used for computing the weights. If rawres\_input is given without covmat\_input, all vectors will be assigned the same PDF, meaning that only delta-ofv will influence the resampling.
\nextopt
\optdefault{inflation}{X}
Default is 1, which is the same as no inflation. If given, the covariance
matrix will be multiplied with this number before the parameter vectors
are sampled from the truncated multivariate normal distribution.
The weights will however still be computed based the non-inflated covariance matrix. 
\nextopt
\end{optionlist}


\section{Algorithm}
\begin{itemize}
\item[\underline{Setup}] Run the input model unless a lst-file with results is already present.
\item[\underline{Step 1}] Simulate 'samples' parameter vectors from covariance matrix found in run0.cov OR covmat.csv. 
Calculate each vector’s probability given the covariance matrix based on the formula for the probability 
density function (PDF) of a multivariate normal distribution. Store parameter values and probabilities in raw\_results.csv.
NB: NOT performed if –rawres\_input is specified.
\item[\underline{Step 2}] evaluate the parameter vectors on the original data.
Create model files with up to 250 \$PROBLEM based on the original model file but setting MAXEVAL=0
and replacing inits of nth \$PROBLEM with nth parameter vector, and also set MCETA if option -mceta was used. Compute dOFV 
(delta-OFV, reference is input model ofv) and store in raw\_results.csv.
\item[\underline{Step 3}] calculate the weights as the ratio $\frac{e^{-0.5\cdot dOFV}}{PDF}$ and store in raw\_results.csv. 
Resample 'resamples' parameter vectors based on these weights, with or without replacement depending on option -with\_replacement. 
Store the number of times each vector was resampled in raw\_results.csv.
Compute the covariance matrix for the resampled parameters (variances and covariances), 
store in NNN. 
Compute univariate confidence intervals (quantiles to be defined) and store in SIR\_results.csv.
\end{itemize}

\section{Output}
\begin{itemize}
\item raw\_results.csv with added columns for
\begin{enumerate}
\item deltaofv = $\mathrm{ofv} - \mathrm{original}\mbox{\tt\string_}\mathrm{model}\mbox{\tt\string_}\mathrm{ofv}$
\item likelihood\_ratio = $e^{-0.5\cdot \mathrm{deltaofv}}$
\item PDF
\item importance\_ratio = $\frac{\mathrm{likelihood}\mbox{\tt\string_}\mathrm{ratio}}{\mathrm{PDF}}$
\item probability\_resample = $\frac{\mathrm{importance}\mbox{\tt\string_}\mathrm{ratio}}{\sum{\mathrm{importance}\mbox{\tt\string_}\mathrm{ratio}}}$
\item resamples = number of actual resamples with random seed used
\end{enumerate}
\item sir\_results.csv with percentiles and empirical covariance matrix
\end{itemize}

\end{document}

\input{inputs/format_header.tex}
\guidetitle{nmoutput2so user guide}{2015-04-20}

\begin{document}

\maketitle

\section{Introduction}
The nmoutput2so script creates and populates a DDMoRe Standardized Output 
\cite{Terranova}
xml file given the output from one or more NONMEM runs. 
It is necessary that the format of the model file and other files follow a set of requirements (see below) for this to work. The Perl module XML::LibXML is required by nmoutput2so, but not PsN in general. Make sure that it is installed before using nmoutput2so. See the PsN installation guide for intructions.


Examples
\begin{verbatim}
nmoutput2so model.lst
\end{verbatim}

\section{Input and options}

\subsection{Required input}
Required argument is a list of nonmem results files (.lst). Wildcards will work (i.e. *.lst)


\subsection{Optional input}

\begin{optionlist}
\optdefault{precision}{10}
The number of significant digits to use for all numerical data in the standard output file.
\nextopt
\optname{bootstrap\_results}
A PsN bootstrap\_results.csv file to use for filling the Bootstrap element.
\nextopt
\optname{use\_tables}
Default set. Will use table files (sdtab and patab) to populate the elements of the SO that needs these. Use -no-use\_tables to not use any table files.
\nextopt
\optname{exclude\_elements}
Set a comma separated list of simple XPaths relative the SOBlock to exclude from the SO.
For example:
\begin{verbatim}
-exclude_elements=Estimation/PopulationEstimates
\end{verbatim}
\nextopt
\optname{only\_include\_elements}
Set a comma separated list of simple XPaths relative the SOBlock. These elements will be the only ones used.
For example: 
\begin{verbatim}
-only_include_elements=Estimation/Likelihood
\end{verbatim}
\nextopt
\optname{message}
Specify a string to be added as an information message in the TaskInformation of the first SOBlock.
\nextopt
\optname{toolname}
The toolname to use for messages. Default is 'NONMEM'
\nextopt
\optname{max\_replicates}
Set a maximum number of simulation replicates to add. Default is to add all replicates
\nextopt
\optname{pretty}
Set if SO should be output with indentations and newlines.
Default is to not add intentations and thus to generate as compact xml files as possible.
\nextopt
\optname{so\_filename}
Set a filename for the resulting SO xml file. If this is not set the file stem of the first .lst file will be used.
\nextopt
\optname{so\_version}
Set the version of the so file to create. Default is 0.2
\nextopt
\optname{pharmml}
Set a name of the pharmml file used to generate the SO
in the PharmMLRef element.
\nextopt
\optname{vebose}
Set to print information, such as all errors and warnings, during conversion to stdout.
\nextopt
\optname{external\_tables}
This option will probably change its format.
Set to use external tables for the simulations
\nextopt
\end{optionlist}

\section{Requirements on the model file and other files}

\subsection{Requirements on the model file}
\begin{itemize}
    \item All NONMEM parameters (THETAs, OMEGAs and SIGMAs) must have labels. A label is a one word (and only one word) comment on the same line as the definition of the initial estimate of the parameter. This means that all block definitions must be written on different rows. Example:
        \begin{verbatim}
$OMEGA BLOCK(2)
 1.2     ; PPV_CL
 0.01    ; CORR_CL_V
 0.1     ; PPV_V
        \end{verbatim}
    \item To be able to populate the Residuals and the Predictions entries an sdtab table must be specified. The name but not the orders of the columns is important. ID and TIME must be in the table. Other columns are optional. The example below shows an sdtab with all columns. The name of the file must start with "sdtab" Example:
        \begin{verbatim}
$TABLE ID TIME DV PRED IPRED RES IRES WRES IWRES NOAPPEND FILE=sdtab2
        \end{verbatim}
    \item To be able to populate the IndividualEstimates entry a patab table must be specified. NOAPPEND must be used and the order of the columns is important. The first column must be ID, then comes all individual parameters followed by the ETAs (see below). Example:
        \begin{verbatim}
$TABLE ID CL V ETA_CL ETA_V NOAPPEND FILE=patab
        \end{verbatim}
    \item To be able to populate the RandomEffects entry all ETAs must be defined in the main code block (\$PK or \$PRED). One ETA should be defined per row with nothing more on the row (except for spaces) than one assignment. Example:
        \begin{verbatim}
 ETA_CL = ETA(1)
 ETA_V = ETA(2)
        \end{verbatim}
\end{itemize}


\subsection{Requirements on other files}
\begin{itemize}
    \item All nonmem result files must have the same filename (excluding extension) as the .lst file. If not it is impossible to pick up the results from the .ext, .cov, .cor files etc.
\end{itemize}

\section{Known limitations}
\begin{itemize}
    \item The full xml file is stored in memory at once. This means that big results, for example big simulations, can potentially use a lot or all of the available memory.
    \item Does not support multiple DVIDs in SimulatedProfiles. Sets all to 1.
    \item Dose rows are included in Residuals, Predictions and SimulatedProfiles. They have value set to 0.
\end{itemize}

\section{Output}

The resulting standardized output object xml will be written to the file called <name of .lst file>.so\_xml.

The following entries will be populated:

\begin{itemize}
    \item TaskInformation
        \begin{itemize}
            \item Message - Errors, warnings etc will be put here
            \item RunTime - From the .lst file
        \end{itemize}
    \item Estimation
        \begin{itemize}
            \item PopulationEstimates
            \begin{itemize}
                \item Bootstrap
                \begin{itemize}
                    \item Mean - From a PsN bootstrap\_results.csv file.
                    \item Median - From a PsN bootstrap\_results.csv file.
                \end{itemize}
                \item MLE - Results will be taken from the .ext file if present otherwise the .lst file. Parameters that are fixed and does not have a label will not be included. The estimated value
                    will be on the standard deviation/correlation scale or variance/covariance scale depending on which scale the initial estimate was on. 
            \end{itemize}
            \item PrecisionPopulationEstimates
            \begin{itemize}
                \item MLE
                \begin{itemize}
                    \item CovarianceMatrix - If the covariance step was successful. Results will be taken from the .cov file if present otherwise from the .lst file.
                    \item CorrelationMatrix - If the covariance step was successful. Results will be taken from the .cor file if present otherwise from the .lst file.
                    \item StandardError - Results will be taken from the .ext file if present otherwise the .lst file. Parameters that are fixed will not be included
                    \item RelativeStandardError - Results will be taken from the .ext file if present otherwise the .lst file. The RSE is calculated has the ratio between the standard error and the estimated value of the parameter. Parameters that are fixed will not be included.
                \end{itemize}
                \item Bootstrap
                \begin{itemize}
                    \item PercentilesCI - From a PsN bootstrap\_results.csv file. Note that all percentiles will be on the variance/covariance scale even if the parameters are specified on the standard deviation/coorelation scale in the model.
                \end{itemize}
            \end{itemize}
            \item IndividualEstimates
            \begin{itemize}
                \item Estimates
                \begin{itemize}
                    \item Median - Calculated from the patab if created
                    \item Mean - Calculated from the patab if created
                \end{itemize}
                \item RandomEffects
                \begin{itemize}
                    \item EffectMedian - Calculated from the patab if ETAs are named correctly
                    \item EffectMean - Calculated from the patab if ETAs are named correctly
                \end{itemize}
            \end{itemize}
            \item Residuals - Taken from the sdtab if present
            \item Predictions - Taken from the sdtab if present
            \item Likelihood
                \begin{itemize}
                    \item Deviance - This is the NONMEM ofv value taken from the .lst file
                \end{itemize}
        \end{itemize}
    \item Simulation 
        \begin{itemize}
            \item SimulationBlock    
            \begin{itemize}
                \item SimulatedProfiles - Taken from the first table that contains all of ID, TIME and DV
                \item IndivParameters - Taken from patab
                \item Covariates - Taken from cotab
            \end{itemize}
        \end{itemize}
\end{itemize}

\subsection{Information messages}
A set of tool specific information messages are added in TaskInformation. They are listed table below:

\begin{itemize}
    \item \textbf{minimization\_successful} \\ Set to 1 if the minimization was successful otherwise set to 0.
    \item \textbf{covariance\_step\_run} \\ Set to 1 if the covariance step was run otherwise set to 0. The information is taken from the .lst file
    \item \textbf{covariance\_step\_successful} \\ Set to 1 if the covariance step was successful
    \item \textbf{covariance\_step\_warnings} \\ Set to 1 if any of "R MATRIX ALGORITHMICALLY SINGULAR" or "S MATRIX ALGORITHMICALLY SINGULAR" is present in the .lst file. Set to 0 otherwise.
    \item \textbf{rounding\_errors} \\ Set to 1 if "ROUNDING ERRORS" is present in the .lst file.  Set to 0 otherwise.
    \item \textbf{hessian\_reset} \\ Set to the number of appearances of "RESET HESSIAN" in the .lst file
    \item \textbf{zero\_gradients} \\ Set to the number of zero gradients in the "GRADIENT" lists of the .lst file
    \item \textbf{final\_zero\_gradients} \\ Number of zero gradients in the final iteration in the .lst file.
    \item \textbf{estimate\_near\_boundary} \\ Set to 1 if any of "ESTIMATE OF THETA IS NEAR THE BOUNDARY" or "PARAMETER ESTIMATE IS NEAR ITS BOUNDARY" is present in the .lst file. Set to 0 otherwise.
    \item \textbf{significant\_digits} \\ NO. OF SIG. DIGITS IN FINAL EST. from .lst file
    \item \textbf{s\_matrix\_singular} \\ Set to 1 if "S MATRIX ALGORITHMICALLY SINGULAR" present in .lst file. Set to 0 otherwise.
    \item \textbf{condition\_number} \\ If the eigenvalues of the correlation matrix was printed to the .lst file (i.e. option PRINT=E was given to \$COV) nnmoutput2so calculates the condition number. 
\end{itemize}


\section{Not supported SO elements}

This section lists all the elements of the SO that is not supported and that will not be added to the xml file.

\begin{verbatim}
SO/
    SOBlock/
        ToolSettings
        TaskInformation/
            OutputFilePath
            NumberChains
            NumberIterations
        Estimation/
            PopulationEstimates/
                Bayesian
            PrecisionPopulationEstimates/
                MLE/
                    FIM
                    AsymptoticCI
                Bayesian
                Bootstrap/
                    PrecisionEstimates
                LLP
                SIR
                MultiDimLLP
                EtaShrinkage
                EpsShrinkage
            IndividualEstimates/
                Estimates/
                    Mode
                    Samples
                RandomEffects/
                    EffectMode
                    Samples
            PrecisionIndividualEstimates
            Residuals/
                PD and NPDE columns
            Likelihood/
                LogLikelihood
                IndividualContribToLL
                InformationCriteria
        Simulation/
            OriginalDataset
            SimulationBlock/
                PopulationParameters
                Dosing
                RawResultsFile
\end{verbatim}

\begin{thebibliography}{1}
\bibitem{Terranova} Nadia Terranova, Marc Lavielle, Mike K. Smith, 
Emmanuelle Comets, Kajsa Harling, Rikard Nordgren, Andrew C. Hooker, 
France Mentre, Maciej J. Swat,
{\em Standardized Output: flexible and tool-independent storage 
format of typical M\&S results}, PAGE 24 (2015) Abstr 3599.
\end{thebibliography}

\end{document}

\input{inputs/format_header.tex}
\setlength{\evensidemargin}{0pt}
\setlength{\oddsidemargin}{0pt}

\guidetitle{update\_inits user guide}{2015-08-05}

\begin{document}

\maketitle


\section{Overview}
The update\_inits script is used to update inital estimates in a model file with final
estimates from NONMEM output.

The final estimates will either be taken from a lst-file given explicitly as the second 
command-line argument after the model file name, from another model file given with option -from\_model, 
or from the lst-file with the same file stem as the model file.
For example, if no lst-file is given as argument and the model file is called run1.mod then the program will try to read output from
run1.lst. If run1.ext also exists then final estimates with higher precision will be read from there, 
but run1.lst must still be present.

In addition to updating initial estimates the program will try to rename table files and
msfo/msfi files that follow certain naming rules. It is also possible to for example
add/update runrecord tags,
randomly perturb initial estimates and add comments to the new model file.

If there are multiple \$PROBLEM then update\_inits will try to update \$PROBLEM by \$PROBLEM.

The command \verb|update| can be used as a synonym to \verb|update_inits|.

\noindent Examples:
\begin{itemize}
\item Update a copy of run1.mod with estimates from run1abc.lst:
\begin{verbatim}
update_inits run1.mod run1abc.lst -output_model=run2.mod
\end{verbatim}
Note: Option -output\_model can be abbreviated to -out.
\item Modify file run33.mod and copy original to run33.mod.org. This requires that run33.lst exists.
\begin{verbatim}
update_inits run33.mod
\end{verbatim}
\item Update a copy of run22.mod and call the new file run23.mod. This requires that run22.lst exists.
\begin{verbatim}
update_inits run22.mod -out=run23.mod
\end{verbatim}
\item Use parameters estimates from a model file instead of a lst-file:
\begin{verbatim}
update run3.mod -from_model=run4.mod -out=run6.mod
\end{verbatim}
\end{itemize}

\section{Renumbering}
\subsubsection*{Input run number for 'Based on' tag}
The program will use the number set with option -based\_on, if that option was used.
Otherwise PsN will try to extract an input run number as follows: If the input model file name
starts with run, Run or RUN followed by a digit and contains a dot 
somewhere after the number, then everthing from the first digit to the first dot will be used as the input run number. Examples:
\begin{itemize}
\item run1.mod gives 1
\item run1.2.mod gives 1
\item Run54a.ctl gives 54a
\item pheno.mod gives nothing
\item RUN55.mod gives number 55
\item Run54abc.ctl gives number 54abc
\item run55 gives nothing (since there is no dot anywhere after the number)
\end{itemize}
\subsubsection*{Output number for \$TABLE, \$ESTIMATION, \$MSFI}
If option -renumber is manually set to a number other than 0, the output run number will
be set to this number. If -renumber is not set but option -output\_model is set,
the program will try to extract an output run number using the same rules
as for the input number for the 'Based on' tag described above.

The output number will be used for the FILE option in \$TABLE, the MSFO option in
\$ESTIMATION, and \$MSFI file name for \$PROBLEMS after the first. 
If no output number is defined, either automatically or via option -renumber, 
then those options will not be changed.

The FILE option of all \$TABLE will get <any number up to optional dot> replaced with <output number>. 
Examples if the output number is 9:
\begin{itemize}
\item FILE=patab01 will be changed to FILE=patab9
\item FILE=mytab88.csv to FILE=mytab9.csv
\item FILE=output5abc.csv to FILE=output9.csv
\end{itemize}

\noindent The MSFO option of all \$ESTIMATION will get <any number up to optional dot> replaced with <output number>. 
Examples if the output number is 9:
\begin{itemize}
\item MSFO=msf8 will be changed to MSFO=msf9
\item MSFO=run50.msf to MSFO=run9.msf
\item MSFO=msf11abc to MSFO=msf9
\end{itemize}

\noindent The file name option of all \$MSFI \emph{after the first \$PROB} will get 
<any number up to optional dot> replaced with <output number>. \$MSFI in the first \$PROB
will not be changed.
Examples if the output number is 9:
\begin{itemize}
\item \$MSFI msf8 will be changed to \$MSFI msf9
\item \$MSFI run8.msf to \$MSFI run9.msf
\end{itemize}

\section{Input and options}

\subsection{Required input}
The name of a model file (control stream file) is required on the command-line.

\subsection{Optional input}
\begin{itemize}
\item The name of the lst-file to read final estimates from. It is given directly on 
the command-line \emph{after the model file} without an option name.
Cannot be used together with option -from\_model. 
If neither a lst-file or -from\_model is given, 
update\_inits will search for a lst-file with the same file stem as the model file, 
but with extension lst.
\end{itemize}
\begin{optionlist}
\optdefault{output\_model}{filename}
The name of the model file to create. If this options is omitted, a copy of
the original model file with extension .org is created, and 
the original file is modified.
\nextopt
\optname{ignore\_missing\_parameters}
Default not set. If set, update\_inits will not require 
a 1-to-1 matching of parameter names and indexes between the model to update and the source
of new estimates (lst-file or other model file).
\nextopt
\optdefault{from\_model}{filename}
The name of a model file to copy initial estimates from. 
Cannot be used together with a named lst-file on the command-line.
\nextopt
\optdefault{comment}{text}
If the option is used, a new line with <comment> will be inserted 
directly following the \$PROBLEM row.
The comment text must be enclosed with quotes (double quotes on Windows) 
if it contains spaces.
\nextopt
\optdefault{degree}{fraction}
Default not set. 
After updating the initial estimates in the output file, randomly
perturb them by degree=X, i.e. change estimate to a value
randomly chosen in the range estimate +/- estimate*X while
respecting upper and lower boundaries, if set.
Degree is set to 0.1 when tweak\_inits is set in execute.
\nextopt
\optname{add\_tags}
Add all runrecord tags. update\_inits will not check if any tags 
are already present.
\nextopt
\optname{ensure\_posdef}
By default not set. 
NONMEM sometimes prints OMEGA or SIGMA matrices
in the lst-file which are not positive definite, and the 
ensure\_posdef option offers a way to fix this.
If option is set then PsN will make a cholesky decomposition of
each OMEGA and SIGMA block to check positive definiteness, and
inflate the diagonal elements of the block with 5\% 
if the cholesky fails.
\nextopt
\optname{flip\_comments}
Default not set. Between each pair of tag lines
\begin{verbatim}
;Sim_start
\end{verbatim}
and
\begin{verbatim}
;Sim_end
\end{verbatim}
remove the first ; on each line that has ; as the first non-blank
character, and prepend with ; at each line that does not
have a ; as the first non-blank character.
This processing will be done as the very first step, which means lines
that are commented out by this procedure will not be updated in the following steps.
\nextopt
\optdefault{add\_prior}{df1,df2,...}
Default not used. Add \$PRIOR NWPRI based on output object. Will automatically read
estimates and covariances from output and use them to define the 
prior. df should be the degrees of freedom, a comma-separated list
with one integer per omega block.
This feature is highly experimental, and you must check \$PRIOR 
in the new model file manually before using it.
Option -add\_prior cannot be used together with option -from\_model. 
Also note that the informative record names \$THETAP, \$THETAPV etc are used,
so the resulting model can only be run with a NONMEM version that 
supports this.
\nextopt
\optdefault{seed}{string}
The random seed for pertubation if option -degree is set.
\nextopt
\optdefault{nm\_version}{string}
Default is 'default'. The formatting of the initial estimates will depend on the
major version number of NONMEM (e.g. 6 or 7) set in psn.conf for the
NM version chosen.
\nextopt
\optdefault{based\_on}{integer}
If the -based\_on option is used, update\_inits will set 
the runrecord 'Based on' tag (if present, or if option -add\_tags is used) 
to that number. 
If -based\_on is not used, update\_inits will by default try to extract 
a run number from the original model file name and use that instead.
If a number cannot be extracted then nothing will be set. 
\nextopt
\optdefault{renumber}{new number}
See details in section Renumbering.
Set option -renumber=0 to prevent automatic renumbering.
\nextopt
\optname{update\_fix}
Default false. If set, update\_inits will update parameters that are FIX in the model.
\nextopt
\optname{fix\_thetas}
Default false. If set, update\_inits will set all THETAs that are not part of a prior to FIX.
\nextopt
\optname{unfix\_thetas}
Default false. If set, update\_inits will remove FIX, if set, from all THETAs that are not part of a prior.
\nextopt

%\optdefault{sigdig}{integer}
%Default 15.
%Only has effect with NONMEM7 and later and if set to a number <15. 
%Print parameter
%estimates with this many digits in the new model file.
%\nextopt
\end{optionlist}

\end{document}

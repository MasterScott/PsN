\input{inputs/format_header.tex}
\guidetitle{FREM tecnical description}
%Kajsa review 2013-11-15

\begin{document}

\maketitle


\section{Introduction}
The frem, Full Random Effects Modelling, script creates a set of models to gradually include random effects on “everything”.
[TODO Description of frem methodology should be added. Reference ?] 

If option -vpc is set then script will prepare model that can be run with vpc.
Example
\begin{verbatim}
frem run1.mod -time_varying=WT -occasion=VISI -parameters=PHI,LAG 
  -invariant=SEX,DGRP -vpc -no-check -estimate=3
\end{verbatim}

\section{Output}
The m1 subdirectory of the frem run directory will contain all the generated models, lst-files for the estimated models, and dataset 2. The main run directory will contain the frem\_vpc model and dataset, if option -vpc was set.

\section{Input and options}
A model file is required on the command-line.

\subsection{Options}
\begin{optionlist}
\optdefault{dv}{name}
Default is DV. The name of the dependent variable. Name used in \$INPUT. 
\nextopt
\optdefault{time\_varying}{list}
A comma-separated list of time-varying covariates. Names used in \$INPUT. Optional if -invariant is given, not allowed if restarting an old run, otherwise required. 
\nextopt
\optdefault{occasion}{name}
Default OCC. The name of the column that defines occasions. Name used in \$INPUT, not data set. Needed if -time\_varying is set, otherwise ignored.   
\nextopt
\optdefault{parameters}{list}
A comma-separated list of model parameters that should have between-occasion variability added. 
Required if -time\_varying is set, otherwise not allowed. 
\nextopt
\optdefault{invariant}{list}
A comma-separated list of covariates that are time invariant. Names used in \$INPUT. Optional if -time\_varying is given, not allowed if restarting an old run, otherwise required. 
\nextopt
\optdefault{start\_eta}{positive integer}
The order number of the first BSV ETA to get correlation with time invariant covariate ETAs. The default is 1, which means all 
BSV ETAs will be correlated to time invariant covariates. Not allowed if restarting an old run, not allowed if -invariant is not set.
\nextopt
\optname{vpc}
Default not set. If set then script will create a frem model that can be run with the vpc script (in a separate call to the vpc pscript).  
\nextopt
\optname{check}
Set by default, disable with -no-check. Run safety check after data set 2 generation. 
\nextopt
\optdefault{estimate}{number}
Optional, default 3. The number (0, 1, 2 or 3) of the last model to estimate in the frem sequence. All models with a higher number will still be created, but not estimated. When restarting in an existing frem run directory, estimation of models that have an existing lst-file will be skipped even if the -estimate option is set to a higher number.
\nextopt
\end{optionlist}

\subsection{Restrictions on the input model}
\begin{itemize}
	\item Time-varying covariates must only vary between occasions, not within occasions. 
	\item There must be no parameter called FREMTYPE in \$INPUT/\$PK/\$PRED/\$ERROR.
	\item Categorical covariates must be bivariate.
    \item All BSV ETAs that are not to get correlation with invariant covariate ETAs have ETA number < -start\_eta.
    \item All BSV ETAs that are to get correlation with invariant covariate ETAs have ETA number >= -start\_eta.
    \item The input model code must not include covariates that are listed in 
    options -invariant or -time\_varying.
    \item The input model must not include BOV on any parameters, only BSV is allowed.
    \item For each parameter listed with option -parameters the input model must have a line \\
    TV$<$par$>$= expression (where expression possibly includes THETA)
    \item For each parameter listed with option -parameters the input model must have a line \\
    $<$par$>$=TV$<$par$>$ (BSV-expression)
    \item If there is no BSV for a parameter listed with option -parameters, 
    i.e. the value is equal to the typical value, the user must still 
    include an expression with 0 in the place of the BSV eta, using the desired form (additive, proportional, exponential,..). 
    This is necessary to enable PsN to automatically add the BOV code. The 0 must be enclosed in parentheses, otherwise the 
    frem program will not recognize it. Example with placeholder for additive inclusion of BOV:\\
    $<$par$>$=TV$<$par$>$ + (0) \\
    Example with placeholder for exponential inclusion of BOV:\\
    $<$par$>$=TV$<$par$>$*EXP(0) 
%	\item TODO: If -vpc is set: Form of TV$<$par$>$ or THETA directly
\end{itemize}

\subsection{Some general PsN-options which are interesting in combination with frem}
For a complete list of common options see common\_options\_defaults\_versions.pdf, or psn\_options -h on the command-line.

\begin{optionlist}
\optdefault{directory}{name}
Name of run directory 
\nextopt
\end{optionlist}

\section{Workflow}
The script first generates a set of template models in the m1 subdirectory, and performs the runs necessary to generate
the frem dataset (Dataset 2) described below. Then the script will proceed to run models 1,2,3 (see definitions below) 
in that order, provided
that option -estimate is set at least as high as the model number. In each step final estimates from the previous run are
used where possible to set suitable initial estimates in the subsequent run. If option -vpc is set, the script will also 
run the vpc1 model using estimates from model 3 as initial estimates, and finally process output to generate a frem vpc model.

\section{Practical considerations}
It can be expected that not all models in the frem sequence minimize successfully, and that this in turns causes subsequent
steps to fail. When this happens, the user can copy the problematic model and data from the m1 subdirectory and experiment with
different initial estimates to get the minimization to succeed. Then the user should manually remove old output files for the
failed run(s) from the m1 subdirectory and replace them with output from the manipulated successful run, using the same 
output file names. It is important to keep output files for all the successful runs, otherwise PsN would rerun all models without output files
in m1.
Finally the frem run should be restarted setting option -directory to the existing directory, and skipping 
options that are not allowed when restarting a run (see information in list of options). The script
will then use the existing output files as a starting point when continuing the analysis.

It can happen that final estimate OMEGA blocks in Model 3 are not positive definite due to rounding errors. Then the scripts
will halt with an error messages. In that case the user should remove all vpc\_model\_1 output files from
the m1 directory, open model\_3.ext and carefully add a small value to the diagonal elements of the problematic omega block,
save the edited model\_3.ext in m1, and restart frem. The program will then read the omega block from model\_3.ext
without running model 3 and then use that block instead.

\section{Model 0, Dataset 0}
The input model, input dataset.

\section{Dataset 2}
Create a new data set.
\begin{enumerate} 
	\item Determine a name for the FREMTYPE column to be added to the input data set. 
TODO: Error check if \$INPUT, \$PK, \$PRED or \$ERROR already contains a variable called FREMTYPE.
	\item In input dataset: Find EVID and/or MDV columns. If neither found then stop with error message. Find DV column. Find FREMTYPE column. Find OCC column, if there are time-varying covariates listed with the time-varying option. For each invariant and time-varying covariate  determine a unique FREMTYPE value > 0. FREMTYPE=0 is reserved for original observations.
	\item Run a dummy NONMEM model where FREMTYPE=0 to filter the original data on any IGNORE/ACCEPT and to get a new data file from \$TABLE where the column headers are the same as in \$INPUT but a FREMTYPE column is added with all zeros as values. Also add MDV if not EVID or MDV in data set. In the dummy models no columns are DROPped or SKIPped. \$TABLE NOPRINT ONEHEADER NOAPPEND.  Do not need to use RFORMAT in \$TABLE since problem with .EQ. and string matching only occurs with IGNORE/ACCEPT.
\item Then loop over each individual: 
\begin{enumerate}
	\item Copy first observation line for individual. i.e. first line where MDV/EVID ==0. 
Loop over each invariant covariate: Add new line just before first observation line for individual. 
Set DV value to covariate value on copied line. 
Set FREMTYPE to type-value for this covariate. 
If MDV present then MDV=0 if have covariate value, MDV=1 if value is missing. 
If EVID present then EVID=0 if non-missing covariate value, otherwise EVID=2. 
Store non-missing covariate values in array, one array per covariate, to be able to compute medians and 
variance-covariance matrix later to be used as initial estimates in \$THETA and \$OMEGA. 
	\item Loop over each occasion (if OCC defined). 
Copy first line observation line for this occasion. 
Warn if multiple  covariate values within the data records of one occasion. 
Inner loop over each time-varying covariate: 
\begin{enumerate}
	\item Add new line as first data set line for this occasion. 
    \item Set DV value to covariate value for this occasion. 
    \item Set FREMTYPE to type-value for this covariate. 
    \item If MDV present then MDV=0 if have covariate value, otherwise MDV=1. 
    If EVID present then EVID=0 if have covariate value, otherwise EVID=2. 
    \item Store non-missing time-varying covariate values (to compute median over occasions for this individual, 
    median is one scalar per covariate.) 
    \item[] (end inner loop over time-varying cov)
\end{enumerate}
\item[] (end loop over occasions)
\item Compute median of time-varying cov over occasions for this individual, median is one scalar per covariate.
\item Then store non-missing medians in array, one array per time-varying covariate, (to compute 
median of medians later for \$THETA, and variance-covariance matrix  to be used in \$OMEGA).
\item[] (end loop over individuals)
\end{enumerate}

	\item Compute medians of invariant and time-varying covariates. Also compute variance-covariance matrix of invariant covariates, and of medians (over occasions) for time-varying. Two separate variance-covariance matrices. If missing values then just skip.
\end{enumerate}

This dataset is used for Model 2 and all consecutive models.

\section{Data check model, Dataset 2}
\subsection{Initiation}
Copy Model 0.

\subsection{DATA changes}
Set \$DATA to dataset 2. Skip old IGNORE/ACCEPT. Set IGNORE=@ IGNORE=(FREMTYPE.GT.0)

\subsection{INPUT changes}
Append extra items to \$INPUT: MDV(possibly) and FREMTYPE.

For safety check, done if option -check is set: Estimate Data check model. OFV should be identical to Model 0 OFV.

\section{Model 1}
This filling in of \$OMEGA is only done if there are invariant covariates listed with the -invariate option.

Copy the input model and change \$OMEGA for \emph{start\_eta} to last eta from whatever form in Model 0 to a single large BLOCK. 
Initials that are non-zero in Model 0 are copied from there or taken from Model 0 lst-file, if present. 
Off-diagonal elements that are new to Model 1 are set to small non-zero values that preserve strict 
diagonal dominance.
% OR compute ETA-covariances from estimation output phi file if available. 
The large \$OMEGA block of Model 1 is called the BSV\_par block.

\section{Model 2-all covariates}

For BOV the script defines a variable BOV$<$par$>$ for each parameter, and then BOV$<$par$>$ is set equal to different ETAs depending on the occasion. Same for BOV$<$covariate$>$. See details below. 
%This method is safer to implement than having switch variables for occasions that are 1 or 0 depending on the occasion, and then use a long sum of products between switch variables and ETAs. 

\subsection{SETUP}
Count number n\_theta of already present THETAS in Model 0. Count number bsv\_parameters of already present ETAs 
(equal to dimensionality of total \$OMEGAs in Model 0) minus (\emph{start\_eta}-1). 
Count number of n\_eps already present (dimensionality of \$SIGMA in Model 0), set epsnum=n\_eps+1.
Build Model 2 based on Model 1, which is only different from Model 0 if option -invariant is set (a filled BSV\_par block).

\subsection{DATA changes}
Set \$DATA to dataset 2. Skip old IGNORE/ACCEPT. Set IGNORE=@.

\subsection{INPUT changes}
Append extra items to \$INPUT: MDV(possibly) and FREMTYPE.

\subsection{OMEGA changes}
If have have time-invariant covariates:
\begin{itemize}
\item BSV\_par: Already have full BSV\_par block from Model 1.
\item BSV\_cov: Add a full BLOCK(N\_invariant) where initials is variance-covariance matrix of invariant covariates computed during creation of dataset.
\end{itemize}
\noindent 
Then, if have time-varying covariates:
\begin{itemize}
\item BOV\_par\_occ1: Add one full BLOCK(bov\_parameters) where initials is: diagonal 0.01 and off-diagonals small enough to make strictly diagonally dominant
At each line, possibly add comment with BOV$<$parameter$>$ to be used as label for ETA in PsN
\item BOV\_par\_occ2-end: Then, for each occasion that is not the first occasion add BLOCK SAME.
\item BOV\_cov\_occ1: Add one full BLOCK(N\_time-var) where initials is variance-covariance matrix of time-varying covariates computed during creation of dataset
At each line, possibly add comment with covariate name to be used as label for ETA in PsN
\item BOV\_cov\_occ2-end: Then, for each occasion that is not the first occasion add BLOCK SAME.
\end{itemize}
\subsection{SIGMA changes}
In \$SIGMA add 
\$SIGMA 0.0000001 FIX; EPSCOV

\subsection{THETA changes}
Loop over all covariates (invariant plus time-varying), j=1...N\_covtot, add lines
\$THETA init ; TVcovname
where init is median of covariate computed during creation of new data set. Store mapping Tvcovname – THETA(n\_theta+j). Possibly set boundaries to max and min for covariate, in that case need to find that during generation of dataset 2.

\subsection{PK or PRED changes at beginning, A}
In \$PK or \$PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR analogue to scm- anchor) the following code: \\
Loop over invariant covariates j=1...N\_invariant, add lines\\
\begin{verbatim}BSV<cov> = ETA(bsv_parameters+j)
\end{verbatim}
Loop over parameters, initialize BOV PK (provided there are any time-varying cov)
\begin{verbatim}BOV<parameter>=0
\end{verbatim}
Loop over occasions k=1...N\_occ , one IF block per occasion
\begin{verbatim}IF (OCC .EQ. k) THEN
\end{verbatim}
[inner loop over parameters j=1...bov\_parameters]
\begin{verbatim}BOV<parameter> = ETA(bsv_parameters+N_invariant+(k-1)*bov_parameters+j)
END IF
\end{verbatim}
Loop over time-varying covariates, initialize BOV tcov
\begin{verbatim}BOV<covariate>=0
\end{verbatim}
Loop over occasions k=1...N\_occ , one IF block per occasion
\begin{verbatim}IF (OCC .EQ. k) THEN
\end{verbatim}
[inner loop over time-varying covariates j=1...N\_time-var]
\begin{verbatim}
BOV<covariate> = ETA(bsv_parameters+N_invariant+N_occ*Nparams+(k-1)*N_time-var+j)
END IF
\end{verbatim}


\subsection{PK or PRED changes at beginning, B}
In \$PK or \$PRED (continuing):
Loop over parameters (provided there are any time-varying cov)
Locate line with 
$<$par$>$ = TV$<$par$>$ (expression containing ETA or (0) as BOV placeholder)
Add BOV$<$parameter$>$ at appropriate place in $<$par$>$=TV$<$par$>$... expression.

\subsection{PRED or ERROR changes at end}
In \$PRED or \$ERROR, whichever is present:
At the very end\\
Loop over invariant covariates, j=1...N\_invariant, use THETA-covname mapping, add lines
\begin{verbatim}
Y<j> = THETA(cov) + BSV<cov>
\end{verbatim}
Loop over time-varying covariates, j=(N\_invariant+1)...(N\_invariant+N\_time-var), use THETA-covname mapping, add lines
\begin{verbatim}
Y<j> = THETA(cov) + BOV<cov>
\end{verbatim}
Loop over all covariates j=1...(N\_invariant+N\_time-var).
For each cov find FREMTYPE integer k from mapping, add IF block code 
\begin{verbatim}
IF (FREMTYPE .EQ.k) THEN
Y=Y<j>+EPS(epsnum)
IPRED=Y<j>
END IF
\end{verbatim}
(do not define a case for FREMTYPE=0, original obs. Leave original code as it is for that)


\section{Model 2-only time-varying}
Use dataset 2 but in \$DATA set IGNORE for all FREMTYPE for invariant covariates. Build model based on Model 0 (no filling in of BSV block). Add code and parameters according to Model 2 instructions above but set the number of invariant covariates N\_invariant to 0

\section{Model 2-only time-invariant}
Use dataset 2 but in \$DATA set IGNORE for all FREMTYPE for time-varying covariates. Build model based on Model 0 (no filling in of BSV block). Add code and parameters according to Model 2 instructions above but set the number of time-varying covariates N\_invariant to 0.

\section{Model 3}

This models have same number of ETAs as Model 2, but the BSV and BOV blocks are filled in, 1+N\_occasions huge \$OMEGA blocks and reordered ETAs. Take care of initials.

\subsection{SETUP}
Same as for Model 2 (build on Model 0 or 1)

\subsection{DATA changes}
Same as Model 2.
\subsection{INPUT changes}
Same as Model 2.

\subsection{OMEGA changes}
BSV\_all: One full BLOCK(bsv\_parameters+N\_invariant) where bsv\_parameters is total dimensionality of \$OMEGAs in Model 0 and N\_inv is number of invariant covariates.
%Initials: EITHER from eta estimates from Model 2 (from .phi-file), compute variance-covariance matrix. OR 
Same initials as in Model 2 plus small values to fill in full block.

Then, provided have time-varying covariates:
BOV\_all\_occ1: Add one full BLOCK(bov\_parameters+N\_time-var) where bov\_parameters is number of parameters set with -parameters option.
%Initials: EITHER from eta estimates from Model 2, compute variance-covariance matrix (.phi-file, must rearrange ETAs to new order in Model 3). OR 
Same initials as in Model 2 plus small values to fill in full BLOCK.
BOV\_all\_occ2-end: Then, for each occasion that is not the first occasion add \$OMEGA BLOCK SAME.

\subsection{SIGMA changes}
Same as Model 2.

\subsection{THETA changes}
Same as Model 2.

\subsection{PK or PRED changes at beginning A}
Very similar to Model 2, but different arrangement of loops so that ETA numbering is different.
In $PK or $PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR analogue to scm- anchor) the following code: 
Loop over invariant covariates j=1...N\_inv, add lines
\begin{verbatim}
BSV<cov> = ETA(bsv_parameters+j)
\end{verbatim}
Loop over parameters, initialize BOV PK (provided there are any time-varying cov)
\begin{verbatim}
BOV<parameter>=0
\end{verbatim}
Loop over time-varying covariates, initialize BOV tcov
\begin{verbatim}
BOV<covariate>=0
\end{verbatim}
Loop over occasions k=1...N\_occ , one IF block per occasion
\begin{verbatim}
IF (OCC .EQ. k) THEN
\end{verbatim}
[First inner loop, over parameters j=1...bov\_parameters]
\begin{verbatim}
BOV<parameter> = ETA(bsv_parameters+N_inv+(k-1)*(bov_parameters+N_variant)+j)
\end{verbatim}
[Second inner loop (still inside IF BLOCK, but outside first inner loop), over time-varying covariates j=1...N\_variant]
\begin{verbatim}
BOV<covariate> = ETA(bsv_parameters+N_inv+(k-1)*(bov_parameters+N_variant)+bov_parameters+j)
END IF
\end{verbatim}

\subsection{PK or PRED changes at beginning B}
Same as Model 2.

\subsection{PRED or ERROR changes at end}
Same as Model 2.

\section{Creating FREM vpc model}
Done if option -vpc is given to FREM script. This part of the recipe describes modifications needed to FREM model and data set before running vpc. Definitions of model types (Model 2 and Model 3) and names of \$OMEGA blocks are as in description above. 

\subsection{Step 1: Obtain typical parameter values conditional on covariate info}
Create frem\_vpc1.mod

\begin{enumerate}
	\item Take input model (Model 3). Update inits from estimation, if available. Afterwards FIX \$THETA and \$OMEGA. Unfix all \$SIGMA.
	\item Set IGNORE=@ IGNORE=(FREMTYPE.GT.0)
	\item Remove \$COV.
	\item In \$PK or \$PRED, whichever is present: 
Find all THETAs on right hand side where left hand is not Y$<$number$>$ or Y. Store mapping THETA number and left hand parameter name. Assume at most one THETA in right hand expression.  
Locate ETAs with numbers start\_eta to (start\_eta-1+bsv\_parameters) 
where bsv\_parameters is the number of BSV etas for parameters. 
Figure out the mapping between ETAnumber and THETAnumber. The script shall handle link 
indirectly via THETA-parameter mapping as in 
\begin{verbatim}
TVCL=THETA(2)
CL=TVCL*EXP(ETA(1))
\end{verbatim}  
Assume no other connections than that. If not find THETA number then raise error.
	\item Add \$TABLE with list of all undropped \$INPUT variables plus names of parameters that have BSV eta  + ONEHEADER NOAPPEND NOPRINT FILE=frem\_vpc.dta
	\item Store sequence of headers in \$TAB to be used in \$INPUT in model frem\_vpc2.mod, but in this list prepend parameter names with CTV to separate from other params.
	\item Run model with NM.
\end{enumerate}

\subsection{Step 3:  Calculate parameter OMEGA conditional on covariate OMEGA}
Create frem\_vpc2.mod
\begin{enumerate}
	\item Base this model on Model 1.
    \item Make the same SIGMA changes as in Model 2. 
    \item Make similar OMEGA changes as in Model 2, but no not add any BSV\_cov block or BOV\_cov\_occN blocks.
    \item Do not add any THETAs.
    \item Copy THETA, SIGMA estimates and 1-(start\_eta-1) leading OMEGA estimates from vpc1.
	\item DATA is frem\_vpc.dta
	\item Set IGNORE=@ 
    \item Make the ``PK or PRED changes at beginning, A'' as in Model 2 except skip all lines involving BSV<cov> or
    BOV<cov>, and renumber remaining ETAs accordingly.
    \item Make the same ``PK or PRED changes at beginning, B'' as in Model 2.
	\item Set \$INPUT to sequence of headers from step 1 (contents of table file frem\_vpc.dta but prepend CTV for params)
	\item Use THETA-parameter and ETA-THETA mappings from Step 1 to set TV$<$par$>$ = CTV$<$par$>$ for 
parameters that have BSV ETA on them.
	\item Read final estimated BSV\_all omega block from lst-file and compute conditional omega block, 
    see Appendix “Compute conditional omega block” below. In \$OMEGA replace BSV\_par block with 
    conditional omega block from computation.
	\item Read final estimated BOV\_full\_occ1 omega block from lst-file from Step 1 compute conditional omega block 
    in the same way as for BSV. In \$OMEGA replace BOV\_par\_occ1 with conditional block.
    \item Remove any \$COV
\end{enumerate}

\subsection{Step 4: Prepare to run  vpc}
Now a regular vpc can be run on frem\_vpc2.mod found in the frem run directory.

\section{Appendix: Compute conditional omega block}
frem\_vpc\_cond\_om.R
Input is omega block from lst-file (or csv file om\_block.csv) 
(Detailed description TODO)
Ok to run on block from BOV omega?



\end{document}

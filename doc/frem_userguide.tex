\input{inputs/format_header.tex}
\guidetitle{FREM technical description}{2014-06-23}


\begin{document}
\newcommand{\guidetoolname}{frem}

\maketitle


\section{Introduction}
The frem program is an aid to the method described in
\emph{A full model approach based on the covariance matrix of parameters and covariates},
PAGE 21 (2012) Abstr 2455, M Karlsson. 
The program step by step builds the model with full random effects.
If option -vpc is set then script will prepare model that can be run with vpc.

Example call
\begin{verbatim}
frem run1.mod -time_varying=WT -occasion=VISI -parameters=PHI,LAG 
  -invariant=SEX,DGRP -vpc -no-check -estimate=3
\end{verbatim}

\section{Output}
The main run directory will contain the frem\_vpc model and frem\_vpc dataset, if option -vpc was set.
The m1 subdirectory of the frem run directory will contain all other generated models, 
lst-files for the estimated models, and dataset 2 (the frem dataset). 

\section{Input and options}
A model file is required on the command-line.

\subsection{Options}
\begin{optionlist}
\optdefault{dv}{name}
Default is DV. The name of the dependent variable. Name used in \$INPUT. 
\nextopt
\optdefault{time\_varying}{list}
A comma-separated list of time-varying covariates. Names used in \$INPUT. Optional if -invariant is given, not allowed if restarting an old run, otherwise required. 
\nextopt
\optdefault{occasion}{name}
Default OCC. The name of the column that defines occasions. Name used in \$INPUT, not data set. Needed if -time\_varying is set, otherwise ignored.   
\nextopt
\optdefault{parameters}{list}
A comma-separated list of model parameters that should have between-occasion variability added. 
Required if -time\_varying is set, otherwise not allowed. 
\nextopt
\optdefault{invariant}{list}
A comma-separated list of covariates that are time invariant. Names used in \$INPUT. Optional if -time\_varying is given, not allowed if restarting an old run, otherwise required. 
\nextopt
\optdefault{start\_eta}{positive integer}
The order number of the first BSV ETA to get correlation with time invariant covariate ETAs. The default is 1, which means all 
BSV ETAs will be correlated to time invariant covariates. Not allowed if restarting an old run, not allowed if -invariant is not set.
\nextopt
\optname{vpc}
Default not set. If set then script will create a frem model that can be run with the vpc script (in a separate call to the vpc pscript).  
\nextopt
\optname{check}
Set by default, disable with -no-check. Run safety check after data set 2 generation. 
\nextopt
\optdefault{estimate}{number}
Optional, default 3. The number (0, 1, 2 or 3) of the last model to estimate in the frem sequence. All models with a higher number will still be created, but not estimated. When restarting in an existing frem run directory, estimation of models that have an existing lst-file will be skipped even if the -estimate option is set to a higher number.
\nextopt
\end{optionlist}

\subsection{Restrictions on the input model}
\begin{itemize}
	\item Time-varying covariates must only vary between occasions, not within occasions. 
	\item There must be no parameter called FREMTYPE in \$INPUT/\$PK/\$PRED/\$ERROR.
	\item Categorical covariates must be bivariate.
    \item All BSV ETAs that are not to have covariance with invariant covariate ETAs estimated must have ETA number < start\_eta.
    \item All BSV ETAs that are to have covariance with invariant covariate ETAs estimated must have ETA number >= start\_eta.
    \item The input model code must not include covariates that are listed in 
    options -invariant or -time\_varying.
    \item The input model must not include BOV on any parameters, only BSV is allowed.
    \item All model parameters (for example CL, V, KA) must be defined using \\
    TV$<$par$>$= expression possibly based on THETA, and\\
    $<$par$>$= expression using TV$<$par$>$ and possibly BSV ETA
    \item For each parameter listed with option -parameters, 
    the line defining $<$par$>$ 
    must include a BSV-expression. Even if there is no 
    BSV for a parameter listed with option -parameters, 
    i.e. the value is equal to the typical value, the user must still 
    include an expression with 0 in the place of the BSV eta, using the desired form (additive, proportional, exponential,..). 
    This is necessary to enable PsN to automatically add the BOV code. The 0 must be enclosed in parentheses, otherwise the 
    frem program will not recognize it. Example with placeholder for additive inclusion of BOV:\\
    $<$par$>$=TV$<$par$>$ + (0) \\
    Example with placeholder for exponential inclusion of BOV:\\
    $<$par$>$=TV$<$par$>$*EXP(0) 
%	\item TODO: If -vpc is set: Form of TV$<$par$>$ or THETA directly
\end{itemize}

\subsection{Some important common PsN options}
For a complete list see common\_options.pdf, 
or psn\_options -h on the commandline.
\input{inputs/basic_options.tex}


\section{Workflow}
The script first generates a set of template models in the m1 subdirectory, and performs the runs necessary to generate
the frem dataset (Dataset 2) described below. Then the script will proceed to run models 1,2,3 (see definitions below) 
in that order, provided
that option -estimate is set at least as high as the model number. In each step final estimates from the previous run are
used where possible to set suitable initial estimates in the subsequent run. If option -vpc is set, the script will also 
run the vpc1 model using estimates from model 3 as initial estimates, and finally process output to generate a frem vpc model.

\section{Practical considerations}
It can be expected that not all models in the frem sequence minimize successfully, and that this in turns 
causes problems or errors in subsequent steps. 
When this happens, the user can copy the problematic model and data from the m1 subdirectory and experiment with
different initial estimates to get the minimization to succeed. Then the user should manually remove old output files for the
failed run from the m1 subdirectory and replace them with output from the manipulated successful run, using the same 
output file names. It is important to keep output files for all the successful runs preceeding the failed run, 
otherwise PsN would rerun all models that do not have output files
in m1. Output files from all steps after the manipulated step should also be removed.
Finally the frem run should be restarted setting option -directory to the existing directory, and skipping 
options that are not allowed when restarting a run (see information in list of options). The script
will then use the existing output files as a starting point when continuing the analysis.

It can happen that final estimate OMEGA blocks in Model 3 are not positive definite due to rounding errors. Then the scripts
will halt with an error messages. In that case the user should remove all vpc\_model\_1 output files from
the m1 directory, open model\_3.ext and carefully add a small value to the diagonal elements of the problematic omega block,
save the edited model\_3.ext in m1, and restart frem. The program will then read the omega block from model\_3.ext
without running model 3 and then use that block instead.

\section{Model 0, Dataset 0}
The input model, input dataset.

\section{Dataset 2}
Create a new data set.
\begin{enumerate} 
	\item In input dataset: Find EVID and/or MDV columns. If neither found then MDV will be added. Find DV column. Find FREMTYPE column. Find OCC column, if there are time-varying covariates listed with the time-varying option. For each invariant and time-varying covariate  determine a unique FREMTYPE value > 0. FREMTYPE=0 is reserved for original observations.
    \item Create a filter model. This is either a dummy NONMEM model or, if MDV has to be added, the original model with MAXEVAL=0 METHOD=ZERO and without \$COV. 
	\item Run the filter model where FREMTYPE=0 to filter the original data on any IGNORE/ACCEPT and to get a new data file from \$TABLE where the column headers are the same as in \$INPUT but a FREMTYPE column is added with all zeros as values. Also add MDV if not EVID or MDV in data set. In the dummy models no columns are DROPped or SKIPped.
\item Then loop over each individual: 
\begin{enumerate}
	\item Copy first observation line for individual. i.e. first line where MDV/EVID ==0. 
Loop over each invariant covariate: Add new line just before first observation line for individual. 
Set DV value to covariate value on copied line. 
Set FREMTYPE to type-value for this covariate. 
If MDV present then MDV=0 if have covariate value, MDV=1 if value is missing. 
If EVID present then EVID=0 if non-missing covariate value, otherwise EVID=2. 
Store non-missing covariate values in array, one array per covariate, to be able to compute medians and 
variance-covariance matrix later to be used as initial estimates in \$THETA and \$OMEGA. 
	\item Loop over each occasion (if OCC defined). 
Copy first line observation line for this occasion. 
Inner loop over each time-varying covariate: 
\begin{enumerate}
	\item Add new line as first data set line for this occasion. 
    \item Set DV value to covariate value for this occasion. 
    \item Set FREMTYPE to type-value for this covariate. 
    \item If MDV present then MDV=0 if have covariate value, otherwise MDV=1. 
    If EVID present then EVID=0 if have covariate value, otherwise EVID=2. 
    \item Store non-missing time-varying covariate values (to compute median over occasions for this individual, 
    median is one scalar per covariate.) 
    \item[] (end inner loop over time-varying cov)
\end{enumerate}
\item[] (end loop over occasions)
\item Compute median of time-varying cov over occasions for this individual, median is one scalar per covariate.
\item Then store non-missing medians in array, one array per time-varying covariate, (to compute 
median of medians later for \$THETA, and variance-covariance matrix  to be used in \$OMEGA).
\item[] (end loop over individuals)
\end{enumerate}

	\item Compute medians of invariant and time-varying covariates. Also compute variance-covariance matrix of invariant covariates, and of medians (over occasions) for time-varying. Two separate variance-covariance matrices. If missing values then just skip.
\end{enumerate}

This dataset is used for Model 2 and all consecutive models.

\section{Data check model, Dataset 2}
\subsection{Initiation}
Copy Model 0.

\subsection{DATA changes}
Set \$DATA to dataset 2. Skip old IGNORE/ACCEPT. Set IGNORE=@ IGNORE=(FREMTYPE.GT.0)

\subsection{INPUT changes}
Append extra items to \$INPUT: MDV(possibly) and FREMTYPE.

For safety check, done if option -check is set: Estimate Data check model. OFV should be identical to Model 0 OFV.

\section{Model 1}
This filling in of \$OMEGA is only done if there are invariant covariates listed with the -invariate option.

Copy the input model and change \$OMEGA for start\_eta to last eta from whatever form in Model 0 to a single large BLOCK. 
Initials that are non-zero in Model 0 are copied from there or taken from Model 0 lst-file, if present. 
Off-diagonal elements that are new to Model 1 are set to small non-zero values.
The large \$OMEGA block of Model 1 is called the BSV\_par block.

\section{Model 2-all covariates}

For BOV the script defines a variable BOV$<$par$>$ for each parameter, and then BOV$<$par$>$ is set equal to different ETAs depending on the occasion. Same for BOV$<$covariate$>$. See details below. 
%This method is safer to implement than having switch variables for occasions that are 1 or 0 depending on the occasion, and then use a long sum of products between switch variables and ETAs. 

\subsection{SETUP}
Count number n\_theta of already present THETAS in Model 0. Count number bsv\_parameters, which is
equal to already present ETAs 
(dimensionality of total \$OMEGAs in Model 0) minus (start\_eta-1). 
Count number of n\_eps already present (dimensionality of \$SIGMA in Model 0), set epsnum=n\_eps+1.
Build Model 2 based on Model 1, which is only different from Model 0 if option -invariant is set (a filled BSV\_par block).

\subsection{DATA changes}
Set \$DATA to dataset 2. Skip old IGNORE/ACCEPT. Set IGNORE=@.

\subsection{INPUT changes}
Append extra items to \$INPUT: MDV(possibly) and FREMTYPE.

\subsection{OMEGA changes}
If have have time-invariant covariates:
\begin{itemize}
\item BSV\_par: Already have full BSV\_par block from Model 1.
\item BSV\_cov: Add a full BLOCK(N\_invariant) where initials is variance-covariance matrix of invariant covariates computed during creation of dataset.
\end{itemize}
\noindent 
Then, if have time-varying covariates:
\begin{itemize}
\item BOV\_par\_occ1: Add one full BLOCK(bov\_parameters) where initials is: diagonal 0.01 and off-diagonals small enough to make
block positive definite.
At each line, possibly add comment with BOV$<$parameter$>$ to be used as label for ETA in PsN
%could in filtering print individual parameters and compute variance??? Use .cov from previous step??? probably not
\item BOV\_par\_occ2-end: Then, for each occasion that is not the first occasion add BLOCK SAME.
\item BOV\_cov\_occ1: Add one full BLOCK(N\_time-var) where initials is variance-covariance matrix of time-varying covariates computed during creation of dataset
At each line, possibly add comment with covariate name to be used as label for ETA in PsN
\item BOV\_cov\_occ2-end: Then, for each occasion that is not the first occasion add BLOCK SAME.
\end{itemize}
\subsection{SIGMA changes}
In \$SIGMA add 
\$SIGMA 0.0000001 FIX; EPSCOV

\subsection{THETA changes}
Loop over all covariates (invariant plus time-varying), j=1...N\_covtot, add lines
\$THETA init ; TVcovname
where init is median of covariate computed during creation of new data set. If median is exactly zero set
init to a very small positive value. 
Store mapping TVcovname – THETA(n\_theta+j). 
TODO: Possibly set boundaries to max and min for covariate, in that case need to find that during generation of dataset 2.

\subsection{PK or PRED changes at beginning, A}
In \$PK or \$PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR analogue to scm- anchor) the following code: \\
Loop over invariant covariates j=1...N\_invariant, add lines

\noindent BSV$<$cov$>$ = ETA(offset+j)

\noindent Loop over parameters, initialize BOV PK (provided there are any time-varying cov)

\noindent BOV$<$parameter$>$=0

\noindent Loop over occasions k=1...N\_occ , one IF block per occasion

\noindent IF (OCC .EQ. k) THEN\\
(inner loop over parameters j=1$\ldots$bov\_parameters)\\
BOV$<$parameter$>$ = ETA(offset+N\_invariant+(k-1)*bov\_parameters+j)\\
END IF

\noindent Loop over time-varying covariates, initialize BOV tcov
BOV$<$covariate$>$=0

\noindent Loop over occasions k=1...N\_occ , one IF block per occasion

IF (OCC .EQ. k) THEN

\noindent (inner loop over time-varying covariates j=1...N\_time-var)

\noindent BOV<covariate> = ETA(offset+N\_invariant+N\_occ*Nparams+(k-1)*N\_time-var+j)\\
END IF

\subsection{PK or PRED changes at beginning, B}
In \$PK or \$PRED (continuing):
Loop over parameters (provided there are any time-varying cov)
Locate line with 
$<$par$>$ = TV$<$par$>$ (expression containing ETA or (0) as BOV placeholder)
Add BOV$<$parameter$>$ at appropriate place in $<$par$>$=TV$<$par$>$... expression.

\subsection{PRED or ERROR changes at end}
In \$PRED or \$ERROR, whichever is present:
At the very end\\
Loop over invariant covariates, j=1...N\_invariant, use THETA-covname mapping, add lines
\begin{verbatim}
Y<j> = THETA(cov) + BSV<cov>
\end{verbatim}
Loop over time-varying covariates, j=(N\_invariant+1)...(N\_invariant+N\_time-var), use THETA-covname mapping, add lines
\begin{verbatim}
Y<j> = THETA(cov) + BOV<cov>
\end{verbatim}
Loop over all covariates j=1...(N\_invariant+N\_time-var).
For each cov find FREMTYPE integer k from mapping, add IF block code 
\begin{verbatim}
IF (FREMTYPE .EQ.k) THEN
Y=Y<j>+EPS(epsnum)
IPRED=Y<j>
END IF
\end{verbatim}
(do not define a case for FREMTYPE=0, original obs. Leave original code as it is for that)


\section{Model 2-only time-varying}
Use dataset 2 but in \$DATA set IGNORE for all FREMTYPE for invariant covariates. Build model based on Model 0 (no filling in of BSV block). Add code and parameters according to Model 2 instructions above but set the number of invariant covariates N\_invariant to 0

\section{Model 2-only time-invariant}
Use dataset 2 but in \$DATA set IGNORE for all FREMTYPE for time-varying covariates. Build model based on Model 0 (no filling in of BSV block). Add code and parameters according to Model 2 instructions above but set the number of time-varying covariates N\_invariant to 0.

\section{Model 3}

This models have same number of ETAs as Model 2, but the BSV and BOV blocks are filled in, 1+N\_occasions huge \$OMEGA blocks and reordered ETAs. Take care of initials.

\subsection{SETUP}
Same as for Model 2 (build on Model 0 or 1)

\subsection{DATA changes}
Same as Model 2.
\subsection{INPUT changes}
Same as Model 2.

\subsection{OMEGA changes}
BSV\_all: One full BLOCK(bsv\_parameters+N\_invariant).
%Initials: EITHER from eta estimates from Model 2 (from .phi-file), compute variance-covariance matrix. OR 
Same initials as in Model 2 plus small values to fill in full block. When Model 2 is estimated
the final estimates can be used to set initials in Model 3.

Then, provided have time-varying covariates:
BOV\_all\_occ1: Add one full BLOCK(bov\_parameters+N\_time-var) where bov\_parameters is number of parameters set with -parameters option.
%Initials: EITHER from eta estimates from Model 2, compute variance-covariance matrix (.phi-file, must rearrange ETAs to new order in Model 3). OR 
Same initials as in Model 2 plus small values to fill in full BLOCK.
BOV\_all\_occ2-end: Then, for each occasion that is not the first occasion add \$OMEGA BLOCK SAME.

\subsection{SIGMA changes}
Same as Model 2.

\subsection{THETA changes}
Same as Model 2.

\subsection{PK or PRED changes at beginning A}
Very similar to Model 2, but different arrangement of loops so that ETA numbering is different.
In $PK or $PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR analogue to scm- anchor) the following code: 
Loop over invariant covariates j=1...N\_inv, add lines
\begin{verbatim}
BSV<cov> = ETA(offset+j)
\end{verbatim}
Loop over parameters, initialize BOV PK (provided there are any time-varying cov)
\begin{verbatim}
BOV<parameter>=0
\end{verbatim}
Loop over time-varying covariates, initialize BOV tcov
\begin{verbatim}
BOV<covariate>=0
\end{verbatim}
Loop over occasions k=1...N\_occ , one IF block per occasion
\begin{verbatim}
IF (OCC .EQ. k) THEN
\end{verbatim}
[First inner loop, over parameters j=1...bov\_parameters]
\begin{verbatim}
BOV<parameter> = ETA(offset+N_invariant+(k-1)*(bov_parameters+N_timevar)+j)
\end{verbatim}
[Second inner loop (still inside IF BLOCK, but outside first inner loop), over time-varying covariates j=1...N\_variant]
\begin{verbatim}
BOV<covariate> = ETA(offset+N_invariant+(k-1)*(bov_parameters+N_timevar)+bov_parameters+j)
END IF
\end{verbatim}

\subsection{PK or PRED changes at beginning B}
Same as Model 2.

\subsection{PRED or ERROR changes at end}
Same as Model 2.

\section{Creating FREM vpc model}
Done if option -vpc is given to FREM script. This part of the recipe describes modifications needed to FREM model and data set before running vpc. Definitions of model types (Model 2 and Model 3) and names of \$OMEGA blocks are as in description above. 

\subsection{Step 1: Obtain typical parameter values conditional on covariate info}
Create frem\_vpc1.mod

\begin{enumerate}
	\item Take input model (Model 3). Update inits from estimation, if available. Afterwards FIX \$THETA and \$OMEGA. Unfix all \$SIGMA.
	\item Set IGNORE=@ IGNORE=(FREMTYPE.GT.0)
	\item Remove \$COV.
	\item In \$PK or \$PRED, whichever is present:
Figure out which parameters that have BSV and/or BOV eta(s) on them. BOV ETAs may not have been present in Model 0, but added in Model 2. 
Parameters may have BOV ETA without BSV eta, and vice versa. 
First take all parameters listed with option -parameters, since they have had BOV ETAs added. Then find additional parameters, 
if any, that have BSV ETA already in model 0.
To do this: Find all code lines starting with TV$<$par$>=$ in Model 0. Then find the lines starting with the corresponding $<$par$>=$ and
check if there is any ETA in the right hand side expression. If yes, then store the parameter name $<$par$>$.  
% If not find THETA number then raise error.
	\item Add \$TABLE with list of all undropped \$INPUT variables plus names of parameters that have BSV eta  + ONEHEADER NOAPPEND NOPRINT FILE=frem\_vpc.dta
	\item Store sequence of headers in \$TAB to be used in \$INPUT in model frem\_vpc2.mod, but in this list prepend parameter names with CTV to separate from other params.
	\item Run model with NM.
\end{enumerate}

\subsection{Step 3:  Calculate parameter OMEGA conditional on covariate OMEGA}
Create frem\_vpc2.mod
\begin{enumerate}
	\item Base this model on Model 1.
    \item Make the same SIGMA changes as in Model 2. 
    \item Make similar OMEGA changes as in Model 2, but no not add any BSV\_cov block or BOV\_cov\_occN blocks.
    \item Do not add any THETAs.
    \item Copy THETA, SIGMA estimates and 1-(start\_eta-1) leading OMEGA estimates from vpc1.
	\item DATA is frem\_vpc.dta
	\item Set IGNORE=@ 
    \item Make the ``PK or PRED changes at beginning, A'' as in Model 2 except skip all lines involving BSV<cov> or
    BOV<cov>, and renumber remaining ETAs accordingly.
    \item Make the same ``PK or PRED changes at beginning, B'' as in Model 2.
	\item Set \$INPUT to sequence of headers from step 1 (contents of table file frem\_vpc.dta but prepend CTV for params)
	\item Use parameter list from Step 1 to set TV$<$par$>$ = CTV$<$par$>$ for 
parameters that have BSV ETA and/or BOV ETA on them.
	\item Read final estimated BSV\_all omega block from lst-file and compute conditional omega block, 
    see Appendix “Compute conditional omega block” below. In \$OMEGA replace BSV\_par block with 
    conditional omega block from computation.
	\item Read final estimated BOV\_full\_occ1 omega block from lst-file from Step 1 compute conditional omega block 
    in the same way as for BSV. In \$OMEGA replace BOV\_par\_occ1 with conditional block.
    \item Remove any \$COV
\end{enumerate}

\subsection{Step 4: Prepare to run  vpc}
Now a regular vpc can be run on frem\_vpc2.mod found in the frem run directory.


\section{Appendix: Compute conditional omega block}
To calculate the conditional covariance matrix, 
one inverts the overall covariance matrix, 
drops the rows and columns corresponding to the variables being conditioned upon, and then inverts back to get the conditional covariance matrix.
% Should use generalized inverse, but we skip that for now
\begin{math}
\Omega^{-1}\Omega = I
\end{math}

To avoid inverting a full matrix, which is numerically wasteful in terms of time and precision, we instead want to perform a sequence of numerically more stable steps.
We have a symmetric $n\times n$ variance-covariance matrix $\Omega$, and want to obtain the leading upper $k\times k$ submatrix $\Omega^{-1}_{11}$
of $\Omega^{-1}$, where
\[
\Omega^{-1} = \left( \begin{array}{cc}
\Omega^{-1}_{11} & \Omega^{-1}_{12}\\
\Omega^{-1}_{21} & \Omega^{-1}_{22} 
\end{array} \right)
\] with sizes \[
\left(
\begin{array}{cc}
k\times k & k\times (n-k)\\
(n-k)\times k & (n-k)\times (n-k) 
\end{array}
\right)
\] 
\begin{enumerate}
\item Make a Cholesky decomposition of omega, $\Omega=GG^T$
\item Obtain the inverse of $\Omega$ by solving the triangular system $G^{T}G^{-T}=I$ for just the $k$ first cols and using $\Omega^{-1}=G^{-T}G^{-1}$
\item We want the upper $k\times k$ submatrix of $\Omega^{-1}=G^{-T}G^{-1}$.
\end{enumerate}
%Ok to run on block from BOV omega?

\end{document} 


  cholFullA=chol(FullA);
invGT=  inv(cholFullA'); %compute only leading k block
[q,R]=qr(invGT(:,1:k));
invR=inv(R(1:k,1:k));
result2=invR*invR' 

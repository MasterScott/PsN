#!/usr/bin/perl

use FindBin qw($Bin);
use lib "$Bin/../lib";

# Don't edit the line below, it must look exactly like this.
# Everything above this line will be replaced #

use PsN;
use output;
use strict;
use Getopt::Long;
use common_options;
use standardised_output;
use model;

$| = 1; # Make sure autoflush is on

my %options;

my %required_options = ();
my %optional_options = ( 
    'h|?'         => undef,
    'help'        => undef,
    'precision:f' => undef,
    'bootstrap_results:s' => undef,
    'so_filename:s' => undef,
);


my $res = GetOptions(\%options, keys(%optional_options));
exit unless $res;

my %defaults;

$defaults{'precision'}                 = 4;

foreach my $opt (keys(%optional_options)) {
  $opt =~ s/[!:|].*//g; #get rid of :s |? :i etcetera
  unless (defined $options{$opt}) {
    $options{$opt} = $defaults{$opt};
  }
}

my %help_text;

$help_text{Pre_help_message} = <<'EOF';
  <h3 class="heading1">nmoutput2so</h3>
    nmoutput2so

    Perl script for creation of a standard output xml file from the nonmem output. 
EOF

$help_text{Options} = <<'EOF';
 Options:

    The options are given here in their long form. Any option may be
    abbreviated to any nonconflicting prefix. 
    
    The following options are valid:
EOF

$help_text{-h} = <<'EOF';
    -h | -?
      
    With -h or -? nmoutput2so will print a list of options and exit.
EOF

$help_text{-help} = <<'EOF';
    -help
      
    With -help nmoutput2so will print this, longer, help message.
EOF

$help_text{-precision} = <<'EOF';
    -precision='integer'
    Default 4

    Output precision.
EOF


common_options::online_help('nmoutput2so', \%options, \%help_text, \%required_options, \%optional_options);

if (scalar(@ARGV) < 1 and not defined $options{'bootstrap_results'}) {
  print "No files specified. Either specify one or more .lst file or use -bootstrap_results. Use 'nmoutput2so -h' for help.\n";
  exit;
}

my $so = standardised_output->new(
    lst_files => \@ARGV,
    bootstrap_results => $options{'bootstrap_results'},
    precision => $options{'precision'},
    so_filename => $options{'so_filename'},
);

$so->parse;

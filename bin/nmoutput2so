#!/usr/bin/perl

use FindBin qw($Bin);
use lib "$Bin/../lib";

# Don't edit the line below, it must look exactly like this.
# Everything above this line will be replaced #

use PsN;
use output;
use strict;
use Getopt::Long;
use common_options;
use standardised_output;
use model;

$| = 1; # Make sure autoflush is on

my %options;

my %required_options = ();
my %optional_options = ( 
    'h|?'         => undef,
    'help'        => undef,
    'precision:f' => undef,
    'bootstrap_results:s' => undef,
    'so_filename:s' => undef,
    'version' => undef,
    'use_tables!' => undef,
    'exclude_elements:s' => undef,
    'only_include_elements:s' => undef,
);


my $res = GetOptions(\%options, keys(%optional_options));
exit unless $res;

my %defaults;

$defaults{'precision'} = 10;
$defaults{'use_tables'} = 1; 

foreach my $opt (keys(%optional_options)) {
  $opt =~ s/[!:|].*//g; #get rid of :s |? :i etcetera
  unless (defined $options{$opt}) {
    $options{$opt} = $defaults{$opt};
  }
}

my %help_text;

$help_text{Pre_help_message} = <<'EOF';
  <h3 class="heading1">nmoutput2so</h3>
    nmoutput2so

    Perl script for creation of a standard output xml file from the nonmem output. 
EOF

$help_text{Options} = <<'EOF';
 Options:

    The options are given here in their long form. Any option may be
    abbreviated to any nonconflicting prefix. 
    
    The following options are valid:
EOF

$help_text{-h} = <<'EOF';
    -h | -?
      
    With -h or -? nmoutput2so will print a list of options and exit.
EOF

$help_text{-help} = <<'EOF';
    -help
      
    With -help nmoutput2so will print this, longer, help message.
EOF

$help_text{-precision} = <<'EOF';
    -precision='integer'
    Default 4

    Output precision.
EOF

$help_text{-use_tables} = <<'EOF';
    -use_tables
    Default used

    Set -no-use_tables to not use any table files (sdtab and patab)
EOF

$help_text{-exclude_elements} = <<'EOF';
    -exclude_elements 

    A comma separated list of paths to elements to exclude
    For example Estimation/PopulationEstimates
EOF

$help_text{-only_include_elements} = <<'EOF';
    -only_include_elements 

    A comma separated list of paths to the elements to include
    No other elements than those listed will be included.
    For example Estimation/PopulationEstimates
EOF

common_options::online_help('nmoutput2so', \%options, \%help_text, \%required_options, \%optional_options);

if ($options{'version'}) {  # FIXME: Should use common_options for this
    print "PsN version: $PsN::version\n";
    exit;
}

if (scalar(@ARGV) < 1 and not defined $options{'bootstrap_results'}) {
  print "No files specified. Either specify one or more .lst file or use -bootstrap_results. Use 'nmoutput2so -h' for help.\n";
  exit;
}

if (defined $options{'only_include_elements'} and defined $options{'exclude_elements'}) {
    die "Can not use both -only_include_elements and -exclude_elements at the same time";
}

my $only_include_elements = common_options::get_option_array($options{'only_include_elements'});
my $exclude_elements = common_options::get_option_array($options{'exclude_elements'});

my $so = standardised_output->new(
    lst_files => \@ARGV,
    bootstrap_results => $options{'bootstrap_results'},
    precision => $options{'precision'},
    so_filename => $options{'so_filename'},
    use_tables => $options{'use_tables'},
    only_include_elements => $only_include_elements,
    exclude_elements => $exclude_elements,
);

$so->parse;

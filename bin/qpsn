#!/bin/bash
# Submit script for PsN jobs..

# Submits a psn job with suitable batch system parameters


NAME=qpsn
#submitargs="-b y -S /bin/bash -cwd -j y"
submitargs="-p core -n 1"

#should look for $HOME/psn.conf and set email address and project id
#if do not find psn.conf then exit with error
#slurm_project
#email_address
project=`sed -n 's/^slurm_project=//p' $HOME/psn.conf`
email=`sed -n 's/^email_address=//p' $HOME/psn.conf`
mail="--mail-user=$email --mail-type=ALL"
if [ -z "$email" ] && [ "${email+xxx}" = "xxx" ]; then $mail=''; fi


while true;do
    case "$1" in
        --help|-h)
            echo "qpsn <PsN command>"
            echo "Example:"
            echo "qpsn execute run12.mod -nm_version=7_12_big -shrinkage"
            exit 0;;
        *) break;;
    esac
done

model=''
if [[ `echo $@|wc -w` -gt 1 ]];then
    tool=$1
    prog=`type -p $tool`;shift
    #loop over $@ to see if slurm_project is set
    for option in $@
    do  
#    	echo $option
	if test `expr match "$option" '\-slurm_pro'` -gt 0; then 
	project=${option##-*=}
	fi
	if test `expr match "$option" '\-no\-sen'` -gt 0; then 
	mail=''
	fi
	if test `expr match "$option" '\-'` -eq 0; then 
	      model=${option%.mod}
	fi
    done
    if [ -z "$model" ] && [ "${model+xxx}" = "xxx" ]; then 
       	 jobname="$tool"
    else
	jobname="$tool"_"$model"
    fi
    #direct stderr and stdout to file with suitable name, jobname plus date_time
    datestring=`date +%b%d-%k:%M:%S`
    file="$jobname"_"$datestring"
    echo ""
    echo "$tool run messages will be printed to file $file"
    echo ""
    echo "sbatch -e $file -o $file -A $project $mail $submitargs -J $jobname $prog $@"
#    qsub $submitargs -N $jobname $prog $@
else
    echo "$0 requires number at least one PsN command as argument"
fi


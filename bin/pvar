#!/usr/bin/perl

# Only for Development
use FindBin qw($Bin);
use lib "$Bin/../lib";

# Don't edit the line below, it must look exactly like this.
# Everything above this line will be replaced #

# Perl includes #
use Config;
use strict;
use Getopt::Long;
# External modules #
use Math::Random;
# PsN includes #
use ui;
use PsN;
use common_options;
use Cwd;
use model;
use tool::pvar;

my %options;

my %required_options = (
	"samples:i" => undef,
	"parameters:s" => undef,
);

my %optional_options = (
);

my $res = GetOptions( \%options,
					  @common_options::get_opt_strings,
						keys(%required_options),
					  keys(%optional_options) );

exit unless $res;

common_options::setup( \%options, 'pval' ); #calls set_globals etc, initiates random sequence

my %help_text;

$help_text{-samples} = <<'EOF';
      Number of simulated datasets to generate.
      Mandatory.
EOF

$help_text{-parameters} = <<'EOF';
      Comma separated list of parameter to investigate.
			Mandatory.
EOF

common_options::online_help('pvar', \%options, \%help_text, \%required_options, \%optional_options);

if (not defined $options{'samples'}) {
	die "Option -samples is required.";
}

if (not defined $options{'parameters'}) {
	die "Option -parameters is required.";
}

# Collect and check the mandatory arguments
my $scm_directory;
my @model_files;

foreach my $arg (@ARGV) {
	if (-d $arg) {
		if (defined $scm_directory) {
			die("Can only take one scm run directory");
		} elsif (@model_files) {
			die("Cannot mix scm_directory and modelfiles");
		} else {
			$scm_directory = $arg;
		}
	} else {
		if (defined $scm_directory) {
			die("Cannot mix scm_directory and modelfiles");
		} else {
			push @model_files, $arg;
		}
	}
}

if (!defined $scm_directory and @model_files == 0) {
	die("Must specify one scm run directory or at least one model file");
}

my @parameters = split(',', $options{'parameters'});

# Collect modelfiles from scm_directory
if (defined $scm_directory) {
	@model_files = pvar->get_models_from_scm_directory($scm_directory);
}

# Create the model objects
my @models;
my $eval_string = common_options::model_parameters(\%options);

foreach my $model_name (@model_files) {
	push(@models, model->new(eval($eval_string),
			filename => $model_name,
		));
}

my $pvar = tool::pvar->new(eval($common_options::parameters),
	samples => $options{'samples'},
	parameters => \@parameters,
	models => \@models);

$pvar->run();


---
title: "Quality assurance"
output: pdf_document # delete if html file needed and set type <- 'html'
header-includes: #needed to create a pdf file
    - \usepackage{colortbl}
    - \usepackage{longtable}
geometry: margin=1.5cm
classoption: a4paper
---


```{r loading_libraries_and_sourcing_functions,include = FALSE,warning=F,message=F}
library(dplyr)
library(knitr)
library(methods)
library(ztable)
library(expm)
library(vpc)
source(paste0(rscripts.directory, "/common/find_r_files_in_subdir.R"))
source(paste0(rscripts.directory, "/common/iofv.R"))
source(paste0(rscripts.directory, "/common/keep_symbols.R"))
source(paste0(rscripts.directory, "/common/command_text.R"))
source(paste0(rscripts.directory, "/cdd/create.data.full.R"))
source(paste0(rscripts.directory, "/simeval/ofv.i_ofv_res.R"))
source(paste0(rscripts.directory,"/frem/ID_ratio_function.R"))
source(paste0(rscripts.directory,"/frem/parameter_ratio_function.R"))
source(paste0(rscripts.directory,"/frem/sd_of_unexpl_var_function.R"))
source(paste0(rscripts.directory,"/simeval/ofv.i_ofv_res.R"))
source(paste0(rscripts.directory,"/simeval/boxplot_i_ofv_res.R"))
#source qa functions
rscript <- find_r_files_in_subdir(toolname,rscripts.directory)
for (i in 1:length(rscript)) {
  source(rscript[i])
}
```


```{r helping_functions,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
# Helping functions
# get a ofv value from the raw_results.csv
.get_rawres_ofv <- function(rawres_file, row = 1){
  read.csv(rawres_file) %>%
    slice(row) %>%
    select(ofv) %>% 
    as.numeric()
}

# get a ofv value from the ext file
.get_ext_ofv <- function(ext_file,iteration=-1000000000){
  read.table(ext_file,header=TRUE,skip=1,stringsAsFactors = F) %>%
    filter(ITERATION==iteration) %>%
    select(OBJ) %>% 
    as.numeric()
}

#which resmod_ folders are in the working directory
resmod_list <- which_resmod_folders(directory=working.directory,idv_name)
idv_all <- resmod_list$all_idvs
```

```{r summary_about_ofv_values,results='asis',echo=FALSE,message=FALSE,warning=FALSE}
ofv_table <- ofv_summary_table(working.directory,model.filename)
```

```{r structural_model_calculations,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
# 1.Structural models
structural_overview <- get_structural_overview_table(directory=working.directory,idv=idv_all,dvid_name,groups)
# get resmod structural details tables
resmod_structural_details <- resmod_structural_details_tables(working.directory,model.filename,CWRES_table,idv_all,idv_name,dvid_name)
```

```{r parameter_model_calculations,results='hide',echo=FALSE,message=FALSE,warning=F}
# 2.Parameter Variability Models
list_par_var_models <- get_param_var_tables(directory=working.directory,model.filename)
param_var_file_exists <- list_par_var_models$param_var_file_exists
par_var_models <- list_par_var_models$par_var_models
fullblock_mod <- list_par_var_models$fullblock_mod
boxcox_mod <- list_par_var_models$boxcox_mod
if(fullblock_mod) {
  full_omega_block_table <- get_full_omega_block(working.directory,param_var_file_exists,list_par_var_models$dofv_block)
}
if(boxcox_mod) {
  boxcox_lambdas_table <- get_boxcox_lambda_table(working.directory,param_var_file_exists,list_par_var_models$dofv_box)
}
if(fullblock_mod || boxcox_mod) {
  param_sector <- TRUE
} else {
  param_sector <- FALSE
}
```

```{r covariate_model_calculations,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
# 3.Covariate Models
  # 3.1.All (FREM)
frem_table_list <- get_all_covariates(frem_directory=file.path(working.directory,"frem_run"),covariates,categorical,parameters,list_par_var_models$dofv_block)
frem_table <- frem_table_list$frem_table
 # 3.2.Covariate (SCM)
scm_table_list <- get_scm_table(file.path(working.directory,paste0("scm_run/raw_results_scm.csv")),
                                parameters,covariates,categorical)
scm_table <- scm_table_list$scm_table
max_scm_table <- scm_table_list$max_scm_table
  #summary
covariates_table_list <- get_covariates_table(frem_table,scm_table,max_scm_table)
covariates_extra_table <- covariates_table_list$covariates_extra_table
covariates_table <- covariates_table_list$covariates_table
```

```{r residual_error_model_calculations,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
#4.create residual error model table (extra table)
resmod_table_list <- get_resmod_ruv_table(directory=working.directory,idv_name,dvid_name)
resmod_ruv_models_table_list <- resmod_table_list$resmod_ruv_table_list
resmod_ruv_overview <- resmod_table_list$resmod_ruv_overview
dvid_nr <- resmod_table_list$dvid_nr
```

```{r influential_individuals_calculations,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
# 5.Influential individuals (CDD)
ii_list <- get_ii_table(raw.results.file=file.path(working.directory,"cdd_run",paste0("raw_results_",sub('.([^.]*)$','',model.filename),"_linbase.csv")),
                        skipped.id.file=file.path(working.directory,"cdd_run/skipped_individuals1.csv"),
                        cutoff=cdd_dofv_cutoff)
cdd_files_exist <- ii_list$cdd_files_exist
cdd.data <- ii_list$cdd.data
cdd_highest_dofv <- ii_list$cdd_highest_dofv
ii_table <- ii_list$ii_table
```

```{r outliers_calculations,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
# 6.Outliers (Simeval)
outlier_table_list <- get_outliers_table(simeval_directory=file.path(working.directory, "simeval_run"),cdd.data)
simeval_files_exist <- outlier_table_list$simeval_files_exist
outliers_table <- outlier_table_list$outliers_table
max_outlier_table <- outlier_table_list$max_outlier_table
```

```{r make_overview_table,results='hide',echo=FALSE,message=FALSE,warning=FALSE}
# get overview table
rgroup <- c("Structural Model","Parameter Variability Model","Covariates","Residual Error Model","Influential Individuals","Outliers")
overview_list <- list(structural_overview,par_var_models,covariates_table,resmod_ruv_overview,cdd_highest_dofv,max_outlier_table)
overview_table_list <- get_overview_table(overview_list,rgroup)
n.rgroup <- overview_table_list$n.rgroup
overview_table <- overview_table_list$overview_table
```

<!-- ###############################   Write Rmarkdown document here   ##################################### -->

```{r command_text_from_command_line,echo=F,results='asis',warning=FALSE,message=F}
command_runtime <- command_text(directory=working.directory)

cat(command_runtime$command,"\n\n")
cat(command_runtime$run_start,"\n\n")
cat(command_runtime$run_finish,"\n\n")
```

```{r draw_ofv_table,echo=F,results='asis',warning=FALSE}
ofv_table <- ztable_sub(ofv_table,type=type,include.rownames = F,colnames.bold = T,align="ll",position = "l")
print(ofv_table)
```

#Overview
```{r draw_overview_table,echo=F,results='asis',warning=FALSE}
overview_table <- keep_symbols(overview_table,type)
overview_table <- ztable_sub(overview_table,type=type,include.rownames = F,colnames.bold = T,align="lrc")
overview_table <- addrgroup(overview_table,rgroup=rgroup,n.rgroup=n.rgroup,cspan.rgroup=1)
print(overview_table)
cat("Overview of possible modifications to different model aspects, expected improvement in OFV as well as number of additional parameters used.")
```

\pagebreak

#Structural

```{r draw_structural_details_tables,warning=F,message=F,echo=F,results='asis'}
if(length(idv_all)!=0) {

  for(i in 1:length(resmod_structural_details)) {
    #tables for vpc plots
    vpc_tables_list <- get_tables_for_vpc(obs_table=CWRES_table,obs_extra_table=paste0(working.directory,"/",sub('.([^.]*)$','',model.filename),"_linbase.dta"),sim_table=paste0(working.directory,"/simeval_run/m1/sim_res_table-1.dta"),sim_extra_table=paste0(working.directory,"/simeval_run/m1/orig_pred.dta"),idv_all,resmod_structural_details[[i]]$dvid,dvid_name)
    make_vpc <- vpc_tables_list$make_vpc
    if(make_vpc) {
      obs <- vpc_tables_list$obs
      sim <- vpc_tables_list$sim
    }
    
    
    perc <- resmod_structural_details[[i]]$perc
    #captions
    all_captions <- captions_structural(idv_all,idv_name,resmod_structural_details[[i]]$idv,perc)
    resmod_dofv_table_captions <- all_captions$idv_resmod_dofv_table_captions
    structural_bias_tables_captions <- all_captions$idv_structural_bias_tables_captions
    structural_bias_plots_captions <- all_captions$idv_structural_bias_plots_captions
    vpc_captions <- all_captions$idv_vpc_captions
    
    #print
    cat(resmod_structural_details[[i]]$idv_text)
    first_table <- keep_symbols(resmod_structural_details[[i]]$first_table,type)
    first_table <- ztable_sub(first_table,type=type,include.colnames = F,include.rownames = F,longtable = T,align="lr")
    print(first_table)
    cat(resmod_dofv_table_captions)
    second_table <- keep_symbols(resmod_structural_details[[i]]$second_table,type)
    second_table <- ztable_sub(second_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align="rlrr")
    second_table <- addcgroup(second_table,cgroup=c("","Estimated bias"),n.cgroup=c(1,2))
    print(second_table)
    cat(structural_bias_tables_captions)
    shift_tab <- resmod_structural_details[[i]]$table
    if(ncol(shift_tab)!=1) {
      cat("\n\n")
      idv_plot <- plot_ipred(shift_tab,resmod_structural_details[[i]]$idv)
      print(idv_plot)
      cat("\n\n")
      cat(structural_bias_plots_captions)
      if(make_vpc) {
        cat("\n\n")
        #vpc plots
        vpc_plot <- plot_structural_vpc(obs,sim,shift_tab,idv=resmod_structural_details[[i]]$idv)
        print(vpc_plot)
        cat("\n\n")
        cat(vpc_captions)
      }
    }
    cat("\n\\newpage\n")
  }
} else {
  print(resmod_structural_details)
}
```

```{asis Add_text_for_parameter_section_if_exist_mod_files, echo=param_sector}
\pagebreak

#Parameter Variability Model
```

```{asis Add_text_for_fullblock_if_exists_mod_file, echo=fullblock_mod}
###Full OMEGA Block
```

```{r draw_full_omega_block_table,echo=F,results='asis'}
if(fullblock_mod) {
  full_omega_block_table <- keep_symbols(full_omega_block_table,type)
  full_omega_block_table <- ztable_sub(full_omega_block_table,type=type,colnames.bold=T,include.rownames=F,longtable=T,align="lrr")
  print(full_omega_block_table)
  cat("Estimated standard deviation (sd) and correlation (corr) as well as expected improvement in OFV when allowing for a full block correlation structure between subject-level random effects.")
}
```

```{asis Add_text_for_boxcox_if_exists_mod_file, echo=boxcox_mod}
###Box-Cox Transformation
```

```{r draw_boxcox_tranformation_table,echo=F,results='asis'}
if(boxcox_mod) {
  boxcox_lambdas_table <- keep_symbols(boxcox_lambdas_table,type)
  boxcox_lambdas_table <- ztable_sub(boxcox_lambdas_table,type=type,colnames.bold=T,include.rownames=F,longtable=T,align="lr")
  print(boxcox_lambdas_table)
  cat("Estimated shape parameters (Lambda) as well as expected improvement in OFV when estimating a Box-Cox transformation for each subject-level random effect.")
}
```

\pagebreak

#Covariates
```{r draw_covariates_table,echo=F,results='asis'}
covariates_extra_table <- keep_symbols(covariates_extra_table,type)
align <- paste(c("l",rep("r",ncol(covariates_extra_table)-1)),collapse = '')
covariates_extra_table <- ztable_sub(covariates_extra_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align=align)
print(covariates_extra_table)
cat("Model parameter covariate relationship, resulting improvement in OFV and estimated covariate coefficient. Furthermore, the sum of all univariate improvements in OFV ignoring between covariate correlations (sum(SCMu)), as well as joint improvement in OFV when taking correlations into account (FREM).")
```

```{r draw_frem_plots,echo=F,message=F,warning=F,results='asis',fig.width=11,fig.height=15,fig.keep="high",fig.align="center"}
if((file.exists(paste0(working.directory,"/postfrem_run/frem_ratio.csv")) || 
   file.exists(paste0(working.directory,"/postfrem_run/frem_id_ratios.csv"))) && 
   file.exists(paste0(working.directory,"/postfrem_run/covdata.csv")) &&
   file.exists(paste0(working.directory,"/postfrem_run/pardata.csv"))) {
  covdata <- read.csv(file.path(working.directory,"postfrem_run","covdata.csv"),header = T, as.is = T)
  pardata <- read.csv(file.path(working.directory,"postfrem_run","pardata.csv"),header = T, as.is = T)
  if(file.exists(paste0(working.directory,"/postfrem_run/frem_ratio.csv"))) {
    inTable_frem <- read.csv(file.path(working.directory,"postfrem_run","frem_ratio.csv"),header = T, as.is = T)
	  cov_effect_on_param_plots <- parameter_ratio(inTable_frem,covdata,pardata)$plots
	  grid.draw(marrangeGrob(cov_effect_on_param_plots,nrow=2,ncol=1,top=''))
	  cat("5th and 95th percentile of each covariate and the size of the effect on parameter (assuming log-normal). The bands show 90% confidence interval around the point estimate. Categorical covariates are compared to the other category.")
	  grid.newpage()
  }
  if(file.exists(paste0(working.directory,"/postfrem_run/frem_id_ratios.csv"))) {
    frem_id <- read.csv(file.path(working.directory,"postfrem_run","frem_id_ratios.csv"), header = T, as.is = T)
	  indiv_for_param_plots <- ID_ratio(frem_id,covdata,pardata)$plots
	  grid.draw(marrangeGrob(indiv_for_param_plots,nrow=2,ncol=1,top=''))
	  cat("Most extreme individuals (in both directions) in terms of expected effect size of their covariate sets, on parameter (assuming log-normal). The bands show 90% confidence interval around the point estimate.")
	  grid.newpage()
  }
  if(file.exists(paste0(working.directory,"/postfrem_run/sd_coefficients_summary.csv"))) {
    sd_coef_summary <- read.csv(file.path(working.directory,"postfrem_run","sd_coefficients_summary.csv"), header = T, as.is = T)
	  sd_unexpl_var_plots <- sd_unexpl_var(sd_coef_summary,covdata,pardata)$plots
	  grid.draw(marrangeGrob(sd_unexpl_var_plots,nrow=2,ncol=1,top=''))
	 # cat("")
	  grid.newpage()
  }
  
}
```

\pagebreak

#Residual Error Model
```{r draw_resiual_error_model_table,echo=F,results='asis'}
for (i in 1:length(resmod_ruv_models_table_list)) {
  if(length(dvid_nr) ==1 && dvid_nr == 'NA') {
    resmod_ruv_models_table <- keep_symbols(resmod_ruv_models_table_list[[i]],type)
    resmod_ruv_models_table <- ztable_sub(resmod_ruv_models_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align="lrcl")
    print(resmod_ruv_models_table)
  } else {
    resmod_ruv_models_table <- keep_symbols(resmod_ruv_models_table_list[[i]],type)
    resmod_ruv_models_table <- ztable_sub(resmod_ruv_models_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align="lrcl",caption = paste0(dvid_name,"=",dvid_nr[i]))
    # cgroup <- c(paste0(dvid_name,"=",dvid_nr[i]))
    # n.cgroup <- c(3)
    # resmod_ruv_models_table <- addcgroup(resmod_ruv_models_table,cgroup=cgroup,n.cgroup=n.cgroup)
    print(resmod_ruv_models_table)
  }
}
cat("Residual error model, resulting expected improvement in OFV as well as required additional model parameters.")
```

\pagebreak

#Influential Individuals
```{r draw_influential_individuals_table,echo=F,results='asis'}
if(cdd_files_exist) {
  if(nrow(ii_table) > cdd_max_rows) {
    ii_table <- ii_table[1:cdd_max_rows,]
  }
}
value <- T
if(ncol(ii_table)==1 && nrow(ii_table)==1) value <- F
ii_table <- keep_symbols(ii_table,type)
ii_table <- ztable_sub(ii_table,type=type,colnames.bold=value,include.colnames=value,include.rownames=F,longtable=T,digits=1,align="lr")
print(ii_table)
cat("Subjects identified as significantly influencing the model fit for all other subjects and their influence in terms of improvement in OFV for other subjects when excluding them during the fit.")
```

\pagebreak

#Outliers
```{r draw_outliers_table,echo=F,results='asis'}
value <- T
if(ncol(outliers_table)==1 && nrow(outliers_table)==1) value <- F
outliers_table <- keep_symbols(outliers_table,type)
outliers_table <- ztable_sub(outliers_table,type=type,colnames.bold = value,include.colnames = value,include.rownames = F,longtable = T,digits = 1,align="lr")
print(outliers_table)
cat("Subjects identified as outliers based on a worse than expected model fit and the corresponding improvement in OFV when excluding them during the fit.")
```

```{r plot_outliers,echo=F,results='asis',warning=F,fig.width=11,fig.height=7}
if(file.exists(file.path(working.directory,"simeval_run/raw_all_iofv.csv"))) {
  list_i_ofv_res <- i_ofv_res(file.path(working.directory,"simeval_run/raw_all_iofv.csv"),show.warning=F)# calculation
  n.subjects <- list_i_ofv_res$n.subjects
  # Make a boxplot
  boxplot_i_ofv_res(list_i_ofv_res,n.subjects)
  cat("High iOFV RES values indicate subjects for which the model describe the data worse than expected. The unit is in SDs different from the expected goodness of fit based on OFV of the observed data relative OFV of simulated data from model.")
}
```

```{r plot_iofv_vs_iofv,echo=F,results='asis',warning=F,fig.width=9,fig.height=6.5,fig.keep="high",fig.align="center"}
 if(rplots.level > 1) {
   phi1 <- file.path(working.directory,"linearize_run/scm_dir1/",paste0(sub('.([^.]*)$','',model.filename),"_linbase.phi"))
   phi2 <- file.path(working.directory,"linearize_run/scm_dir1/derivatives.phi")
   if(file.exists(phi1) && file.exists(phi2)) {
     plot_iofv_vs_iofv <- iofv_vs_iofv(phi1,phi2)
     print(plot_iofv_vs_iofv)
     cat("Agreement in individual OFV contribution (iOFV) between non-linear and linearized model.")
   }
 }
```
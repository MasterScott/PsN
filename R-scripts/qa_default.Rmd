---
title: "Quality assurance"
output: pdf_document # delete if html file needed and set type <- 'html'
header-includes: #needed to create a pdf file
    - \usepackage{colortbl}
    - \usepackage{longtable}
geometry: margin=1.5cm
classoption: a4paper
---


```{r loading_libraries_and_sourcing_functions,include=F,warning=F,message=F}
library(dplyr)
library(tidyr)
library(knitr)
library(methods)
library(ztable)
library(expm)
library(vpc)
library(ggplot2)
library(xpose)
source(file.path(rscripts.directory, "/common/find_r_files_in_subdir.R"))
source(file.path(rscripts.directory, "/common/iofv.R"))
source(file.path(rscripts.directory, "/common/keep_symbols.R"))
source(file.path(rscripts.directory, "/common/command_text.R"))
source(file.path(rscripts.directory, "/cdd/create.data.full.R"))
source(file.path(rscripts.directory, "/simeval/ofv.i_ofv_res.R"))
source(file.path(rscripts.directory,"/frem/ID_ratio_function.R"))
source(file.path(rscripts.directory,"/frem/parameter_ratio_function.R"))
source(file.path(rscripts.directory,"/frem/sd_of_unexpl_var_function.R"))
source(file.path(rscripts.directory,"/simeval/ofv.i_ofv_res.R"))
source(file.path(rscripts.directory,"/simeval/boxplot_i_ofv_res.R"))
#source qa functions
rscript <- find_r_files_in_subdir(toolname,rscripts.directory)
for (i in 1:length(rscript)) {
  source(rscript[i])
}
```


```{r helping_functions,results='hide',echo=F,warning=F,message=F}
# Helping functions
# get a ofv value from the raw_results.csv
.get_rawres_ofv <- function(rawres_file, row = 1){
  read.csv(rawres_file) %>%
    slice(row) %>%
    select(ofv) %>% 
    as.numeric()
}

# get a ofv value from the ext file
.get_ext_ofv <- function(ext_file,iteration=-1000000000){
  read.table(ext_file,header=TRUE,skip=1,stringsAsFactors = F) %>%
    filter(ITERATION==iteration) %>%
    select(OBJ) %>% 
    as.numeric()
}

#which resmod_ folders are in the working directory
idv_all <- which_resmod_folders(directory=working.directory,idv_name)
```

<!-- ##############################   Calculations  #################################### -->

```{r summary_about_ofv_values,results='asis',echo=F,warning=F,message=F}
ofv_table <- ofv_summary_table(working.directory,model.filename)
```

```{r structural_model_calculations,results='hide',echo=F,warning=F,message=F}
# 1.Structural models
structural_overview <- get_structural_overview_table(directory=working.directory,idv=idv_all,dvid_name,groups)
# get resmod structural details tables
resmod_structural_details <- resmod_structural_details_tables(working.directory,model.filename,CWRES_table,idv_all,idv_name,dvid_name)
```

```{r parameter_model_calculations,results='hide',echo=F,warning=F,message=F}
# 2.Parameter Variability Models
list_par_var_models <- get_param_var_tables(directory=working.directory,model.filename)
par_var_models <- list_par_var_models$par_var_models
fullblock_mod <- list_par_var_models$fullblock_mod
boxcox_mod <- list_par_var_models$boxcox_mod
tdist_mod <- list_par_var_models$tdist_mod
if(fullblock_mod) {
  full_omega_block_table <- get_full_omega_block(working.directory,list_par_var_models$dofv_block)
}
if(boxcox_mod) {
  boxcox_lambdas_list <- get_param_extra_table(directory=working.directory,dofv=list_par_var_models$dofv_box,param_model="boxcox")
  boxcox_lambdas_orig <- boxcox_lambdas_list$param_extra_table_orig
  boxcox_lambdas_table <- boxcox_lambdas_list$param_extra_table
}
if(tdist_mod) {
  tdist_list <- get_param_extra_table(directory=working.directory,dofv=list_par_var_models$dofv_tdist,param_model="tdist")
  tdist_table_orig <- tdist_list$param_extra_table_orig
  tdist_table <- tdist_list$param_extra_table
}
if(fullblock_mod || boxcox_mod || tdist_mod) {
  param_sector <- TRUE
} else {
  param_sector <- FALSE
}
```

```{r boxcox_shape_table_for_plot,results='hide',echo=F,warning=F,message=F}
eta_table <- get_eta_values(working.directory=file.path(working.directory,"modelfit_run"),param_model="boxcox")
if(exists("boxcox_lambdas_orig")) {
  list_boxcox_shape <- tables_for_boxcox_shape(boxcox_lambdas_orig)
  make_boxcox_shape_plot <- list_boxcox_shape$make_boxcox_shape_plot
  if(make_boxcox_shape_plot) {
    boxcox_shape_table <- list_boxcox_shape$boxcox_shape_table
    fig_height_boxcox <- list_boxcox_shape$fig_height_boxcox
  }
} else {
  fig_height_boxcox <- 15
  make_boxcox_shape_plot <- FALSE
}
```


```{r covariate_model_calculations,results='hide',echo=F,warning=F,message=F}
# 3.Covariate Models
  # 3.1.All (FREM)
frem_table_list <- get_all_covariates(frem_directory=file.path(working.directory,"frem_run"),covariates,categorical,parameters,list_par_var_models$dofv_block)
frem_table <- frem_table_list$frem_table
 # 3.2.Covariate (SCM)
scm_table_list <- get_scm_table(file.path(working.directory,"scm_run/raw_results_scm.csv"),
                                parameters,covariates,categorical)
scm_table <- scm_table_list$scm_table
max_scm_table <- scm_table_list$max_scm_table
  #summary
covariates_table_list <- get_covariates_table(frem_table,scm_table,max_scm_table)
covariates_extra_table <- covariates_table_list$covariates_extra_table
covariates_table <- covariates_table_list$covariates_table
```

```{r residual_error_model_calculations,results='hide',echo=F,warning=F,message=F}
#4.create residual error model table (extra table)
resmod_table_list <- get_resmod_ruv_table(directory=working.directory,idv_name,dvid_name)
resmod_ruv_models_table_list <- resmod_table_list$resmod_ruv_table_list
resmod_ruv_overview <- resmod_table_list$resmod_ruv_overview
dvid_nr <- resmod_table_list$dvid_nr
```

```{r influential_individuals_calculations,results='hide',echo=F,warning=F,message=F}
# 5.Influential individuals (CDD)
ii_list <- get_ii_table(raw.results.file=file.path(working.directory,"cdd_run",paste0("raw_results_",sub('.([^.]*)$','',model.filename),"_linbase.csv")),
                        skipped.id.file=file.path(working.directory,"cdd_run/skipped_individuals1.csv"),
                        cutoff=cdd_dofv_cutoff,
                        max_rows=cdd_max_rows)
all_dofv <- ii_list$all_dofv
cdd.data <- ii_list$cdd.data
cdd_highest_dofv <- ii_list$cdd_highest_dofv
ii_table <- ii_list$ii_table
infl_id <- ii_list$infl_id
fig_height_infl <- ii_list$fig_height_infl
```

```{r outliers_calculations,results='hide',echo=F,warning=F,message=F}
# 6.Outliers (Simeval)
outlier_table_list <- get_outliers_table(simeval_directory=file.path(working.directory, "simeval_run"),cdd.data)
outliers_table <- outlier_table_list$outliers_table
max_outlier_table <- outlier_table_list$max_outlier_table
outlier_ids <- outlier_table_list$outlier_ids
fig_height_outl <- outlier_table_list$fig_height_outl
```

```{r make_overview_table,results='hide',echo=F,warning=F,message=F}
# get overview table
overview_table_list <- get_overview_table(structural_overview=structural_overview,param_var_overview=par_var_models,covariates_overview=covariates_table,resmod_ruv_overview=resmod_ruv_overview,infl_indiv_overview=cdd_highest_dofv,outliers_overview=max_outlier_table)
rgroup_names <- overview_table_list$rgroup_names
n.rgroup <- overview_table_list$n.rgroup
overview_table <- overview_table_list$overview_table
```

<!-- #######################   Write Rmarkdown document here   ################################ -->

```{r command_text_from_command_line,results='asis',echo=F,warning=F,message=F}
command_runtime <- command_text(directory=working.directory)

cat(command_runtime$command,"\n\n")
cat(command_runtime$run_start,"\n\n")
cat(command_runtime$run_finish,"\n\n")
```

```{r draw_ofv_table,results='asis',echo=F,warning=F,message=F}
ofv_table <- ztable_sub(ofv_table,type=type,include.rownames = F,colnames.bold = T,align="ll",position = "l")
print(ofv_table)
```

#Overview
```{r draw_overview_table,results='asis',echo=F,warning=F,message=F}
overview_table <- keep_symbols(overview_table,type)
overview_table <- ztable_sub(overview_table,type=type,include.rownames = F,colnames.bold = T,align="lrc")
overview_table <- addrgroup(overview_table,rgroup=rgroup_names,n.rgroup=n.rgroup,cspan.rgroup=1)
print(overview_table)
cat("Overview of possible modifications to different model aspects, expected improvement in OFV as well as number of additional parameters used.")
```

\pagebreak

#Structural

```{r draw_structural_details_tables,results='asis',echo=F,warning=F,message=F}
all_structural_extra_plots(working.directory,model.filename,resmod_structural_details,CWRES_table,idv_all,idv_name,dvid_name,type)
```

```{asis Add_text_for_parameter_section_if_exist_mod_files, echo=param_sector}
\pagebreak

#Parameter Variability Model
```

```{asis Add_text_for_fullblock_if_exists_mod_file, echo=fullblock_mod}
###Full OMEGA Block
```

```{r draw_full_omega_block_table,results='asis',echo=F,warning=F,message=F}
if(fullblock_mod) {
  full_omega_block_table <- keep_symbols(full_omega_block_table,type)
  full_omega_block_table <- ztable_sub(full_omega_block_table,type=type,colnames.bold=T,include.rownames=F,longtable=T,align="lrr")
  print(full_omega_block_table)
  cat("Estimated standard deviation (sd) and correlation (corr) as well as expected improvement in OFV when allowing for a full block correlation structure between subject-level random effects.")
}
```

```{asis Add_text_for_boxcox_if_exists_mod_file, echo=boxcox_mod}
###Box-Cox Transformation
```

```{r draw_boxcox_tranformation_table,results='asis',echo=F,warning=F,message=F}
if(boxcox_mod) {
  boxcox_lambdas_table <- keep_symbols(boxcox_lambdas_table,type)
  boxcox_lambdas_table <- ztable_sub(boxcox_lambdas_table,type=type,colnames.bold=T,include.rownames=F,longtable=T,align="lrrr")
  print(boxcox_lambdas_table)
  cat("Estimated shape parameters (Lambda) as well as expected improvement in OFV when estimating a Box-Cox transformation for each subject-level random effect.")
}
```

```{r plot_boxcox_shape,results='asis',echo=F,warning=F,message=F,fig.width=11,fig.height=fig_height_boxcox,fig.keep="high",fig.align="center"}
if(make_boxcox_shape_plot) {
   boxcox_shape_plot <- plot_boxcox_shape(data_table=boxcox_shape_table,eta_table)
  for(i in 1:length(boxcox_shape_plot)) {
    print(boxcox_shape_plot[[i]])
  }
}
```

```{asis Add_text_for_tdist_if_exists_mod_file, echo=tdist_mod}
###t-distribution
```

```{r draw_tdist_table,results='asis',echo=F,warning=F,message=F}
if(tdist_mod) {
  tdist_table <- keep_symbols(tdist_table,type)
  tdist_table <- ztable_sub(tdist_table,type=type,colnames.bold=T,include.rownames=F,longtable=T,align="lrrr")
  print(tdist_table)
}
```

\pagebreak

#Covariates
```{r draw_covariates_table,results='asis',echo=F,warning=F,message=F}
covariates_extra_table <- keep_symbols(covariates_extra_table,type)
align <- paste(c("l",rep("r",ncol(covariates_extra_table)-1)),collapse = '')
covariates_extra_table <- ztable_sub(covariates_extra_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align=align)
print(covariates_extra_table)
cat("Model parameter covariate relationship, resulting improvement in OFV and estimated covariate coefficient. Furthermore, the sum of all univariate improvements in OFV ignoring between covariate correlations (sum(SCMu)), as well as joint improvement in OFV when taking correlations into account (FREM).")
```

```{r draw_frem_plots,results='asis',echo=F,warning=F,message=F,fig.width=11,fig.height=15,fig.keep="high",fig.align="center"}
all_frem_plots(working.directory)
```

\pagebreak

#Residual Error Model
```{r draw_resiual_error_model_table,results='asis',echo=F,warning=F,message=F}
for (i in 1:length(resmod_ruv_models_table_list)) {
  if(length(dvid_nr) ==1 && dvid_nr == 'NA') {
    resmod_ruv_models_table <- keep_symbols(resmod_ruv_models_table_list[[i]],type)
    resmod_ruv_models_table <- ztable_sub(resmod_ruv_models_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align="lrcl")
    print(resmod_ruv_models_table)
  } else {
    resmod_ruv_models_table <- keep_symbols(resmod_ruv_models_table_list[[i]],type)
    resmod_ruv_models_table <- ztable_sub(resmod_ruv_models_table,type=type,colnames.bold = T,include.rownames = F,longtable = T,align="lrcl",caption = paste0(dvid_name,"=",dvid_nr[i]))
    # cgroup <- c(paste0(dvid_name,"=",dvid_nr[i]))
    # n.cgroup <- c(3)
    # resmod_ruv_models_table <- addcgroup(resmod_ruv_models_table,cgroup=cgroup,n.cgroup=n.cgroup)
    print(resmod_ruv_models_table)
  }
}
cat("Residual error model, resulting expected improvement in OFV as well as required additional model parameters.")
```

\pagebreak

#Influential Individuals
```{r draw_influential_individuals_table,results='asis',echo=F,warning=F,message=F}
value <- T
if(ncol(ii_table)==1 && nrow(ii_table)==1) value <- F
ii_table <- keep_symbols(ii_table,type)
ii_table <- ztable_sub(ii_table,type=type,colnames.bold=value,include.colnames=value,include.rownames=F,longtable=T,digits=1,align="lr")
print(ii_table)
cat("Subjects identified as significantly influencing the model fit for all other subjects and their influence in terms of improvement in OFV for other subjects when excluding them during the fit.")
```

```{r histogram_of_cdd_dofv,results='asis',echo=F,warning=F,message=F,fig.width=11,fig.height=6}
hist_of_cdd_dofv(data=all_dofv)
```

```{r add_infl_indiv_individual_plots,results='asis',echo=F,warning=F,message=F,fig.width=11,fig.height=fig_height_infl}
if(length(infl_id)>0) {
  infl.ind_individual_plots <- individual_plots(file_name=file.path(working.directory,"linearize_run/scm_dir1/derivatives.mod"),
                                              ID_nr=infl_id[1:10])
  print(infl.ind_individual_plots)
}
```

\pagebreak

#Outliers
```{r draw_outliers_table,results='asis',echo=F,warning=F,message=F}
value <- T
if(ncol(outliers_table)==1 && nrow(outliers_table)==1) value <- F
outliers_table <- keep_symbols(outliers_table,type)
outliers_table_z <- ztable_sub(outliers_table,type=type,colnames.bold = value,include.colnames = value,include.rownames = F,longtable = T,digits = 1,align="lr")
print(outliers_table_z)
cat("Subjects identified as outliers based on a worse than expected model fit and the corresponding improvement in OFV when excluding them during the fit.")
```

```{r plot_outliers,results='asis',echo=F,warning=F,message=F,fig.width=11,fig.height=7}
if(file.exists(file.path(working.directory,"simeval_run/raw_all_iofv.csv"))) {
  list_i_ofv_res <- i_ofv_res(file.path(working.directory,"simeval_run/raw_all_iofv.csv"),show.warning=F)# calculation
  n.subjects <- list_i_ofv_res$n.subjects
  # Make a boxplot
  boxplot_i_ofv_res(list_i_ofv_res,n.subjects)
  cat("High iOFV RES values indicate subjects for which the model describe the data worse than expected. The unit is in SDs different from the expected goodness of fit based on OFV of the observed data relative OFV of simulated data from model.")
}
```

```{r add_outliers_individual_plots,results='asis',echo=F,warning=F,message=F,fig.width=11,fig.height=fig_height_outl}
if(length(outlier_ids)>0) {
  outlier_individual_plots <- individual_plots(file_name=file.path(working.directory,"linearize_run/scm_dir1/derivatives.mod"),
                                              ID_nr=outlier_ids)
  print(outlier_individual_plots)
}
```
\pagebreak

```{r plot_iofv_vs_iofv,results='asis',echo=F,warning=F,message=F,fig.width=9,fig.height=6.5,fig.keep="high",fig.align="center"}
 if(rplots.level > 1) {
   phi1 <- file.path(working.directory,"linearize_run/scm_dir1",paste0(sub('.([^.]*)$','',model.filename),"_linbase.phi"))
   phi2 <- file.path(working.directory,"linearize_run/scm_dir1/derivatives.phi")
   if(file.exists(phi1) && file.exists(phi2)) {
     make_iofv_plot <- iofv_vs_iofv(phi1,phi2)$make_plot
     if(make_iofv_plot) {
       plot_iofv_vs_iofv <- iofv_vs_iofv(phi1,phi2)$plot
       print(plot_iofv_vs_iofv)
       cat("Agreement in individual OFV contribution (iOFV) between non-linear and linearized model.")
     }
   }
 }
```
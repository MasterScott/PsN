---
title: "Quality assurance"
output: pdf_document # delete if html file needed and set type="html"
header-includes: #needed to create a pdf file
    - \usepackage{colortbl}
    - \usepackage{longtable}
classoption: landscape
geometry: margin=1.5cm
---

```{r source_functions,include = FALSE}
library(dplyr)
library(knitr)
library(methods)
library(ztable)
library(expm)
source(paste0(rscripts.directory, "/common/find_r_files_in_subdir.R"))
source(paste0(rscripts.directory, "/cdd/create.data.full.R"))
source(paste0(rscripts.directory, "/simeval/ofv.i_ofv_res.R"))
#source qa functions
rscript <- find_r_files_in_subdir(toolname,rscripts.directory)
for (i in 1:length(rscript)) {
  source(rscript[i])
}
```

```{r calculations,results='hide',echo=FALSE,message=FALSE}
# Helping functions
# get a ofv value from the raw_results.csv
.get_rawres_ofv <- function(rawres_file, row = 1){
  read.csv(rawres_file) %>%
    slice(row) %>%
    select(ofv) %>% 
    as.numeric()
}

# get a ofv value from the ext file
.get_ext_ofv <- function(ext_file){
  read.table(ext_file,header=TRUE,skip=1,stringsAsFactors = F) %>%
    filter(ITERATION==-1000000000) %>%
    select(OBJ) %>% 
    as.numeric()
}

#round values in a dataframe
.round_values <- function(data_frame,col,dec) {
  if(missing(col)) col="dofv"
  if(missing(dec)) dec=2
  data_frame[,which(colnames(data_frame) %in% col)] <- round(data_frame[,which(colnames(data_frame) %in% col)],dec)
  data_frame
}

#which resmod_ folders are in the working directory
resmod_suffix <- which_resmod_folders(directory=working.directory)

# 1.Structural models
structural_overview <- get_structural_overview_table(working.directory,idv=resmod_suffix)
# get resmod structural details tables
resmod_structural_details <- resmod_structural_details_tables(working.directory,model.directory,model.filename,CWRES_table,resmod_suffix,idv_name)

# 2.Parameter Variability Models
list_par_var_models <- get_param_var_tables(directory=working.directory,n.eta)
par_var_models <- list_par_var_models$par_var_models
full_omega_block_table <- list_par_var_models$full_omega_block_table
boxcox_lambdas_table <- list_par_var_models$boxcox_lambdas_table


# 3.Covariate Models
  # 3.1.All (FREM)
frem_table_list <- get_all_covariates(frem_directory=file.path(working.directory,"frem_run"),covariates,categorical)
frem_files_exists <- frem_table_list$frem_files_exists
frem_table <- frem_table_list$frem_table
 # 3.2.Covariate (SCM)
scm_table_list <- get_scm_table(file.path(working.directory,paste0("scm_run/raw_results_",sub('.mod.*','',model.filename),".csv")),
                                parameters,covariates,categorical)
scm_files_exists <- scm_table_list$scm_files_exists
scm_table <- scm_table_list$scm_table
  #summary
covariates_table_list <- get_covariates_table(frem_table,scm_table,frem_files_exists,scm_files_exists)
covariates_extra_table <- covariates_table_list$covariates_extra_table
covariates_table <- covariates_table_list$covariates_table


#4.create residual error model table (extra table)
resmod_table_list <- get_resmod_ruv_table(directory=file.path(working.directory), idv_name)
resmod_ruv_models_table <- resmod_table_list$resmod_ruv_table
resmod_ruv_overview <- resmod_table_list$resmod_ruv_overview


# 5.Influential individuals (CDD)
ii_list <- get_ii_table(cdd_directory=file.path(working.directory,"cdd_run"),cutoff=cdd_dofv_cutoff)
cdd_files_exist <- ii_list$cdd_files_exist
cdd.data <- ii_list$cdd.data
cdd_highest_dofv <- ii_list$cdd_highest_dofv
ii_table <- ii_list$ii_table


# 6.Outliers (Simeval)
outlier_table_list <- get_outliers_table(simeval_directory=file.path(working.directory, "simeval_run"),cdd.data)
simeval_files_exist <- outlier_table_list$simeval_files_exist
outliers_table <- outlier_table_list$outliers_table
max_outlier_table <- outlier_table_list$max_outlier_table


# get overview table
rgroup <- c("Structural Model","Parameter Variability Model","Covariates","Residual Error Model","Influential Individuals","Outliers")
overview_list <- list(structural_overview,par_var_models,covariates_table,resmod_ruv_overview,cdd_highest_dofv,max_outlier_table)

overview_table_list <- get_overview_table(overview_list,rgroup)
n.rgroup <- overview_table_list$n.rgroup
overview_table <- overview_table_list$overview_table

```

#Overview
```{r draw_overview_table,echo=F,results='asis'}
overview_table <- ztable(overview_table)
overview_table <- addrgroup(overview_table,rgroup=rgroup,n.rgroup=n.rgroup,cspan.rgroup=1)
overview_table <- update_ztable(overview_table,type=type,colnames.bold = T)
print(overview_table)
```

#Structural
```{r draw_structural_details_tables,echo=F,results='asis'}
for(i in 1:length(resmod_suffix)) {
  cat(resmod_suffix[i])
  first_table <- ztable(resmod_structural_details[[i]]$first_table)
  first_table <- update_ztable(first_table,type=type,include.colnames = F,include.rownames = F,longtable = T)
  print(first_table)
  second_table <- ztable(resmod_structural_details[[i]]$second_table)
  second_table <- addcgroup(second_table,cgroup=c("","Mean"),n.cgroup=c(1,2))
  second_table <- update_ztable(second_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
  print(second_table)
}
```

#Parameter Variability Model

###Full OMEGA Block
```{r draw_full_omega_block_table,echo=F,results='asis'}
full_omega_block_table <- ztable(full_omega_block_table)
full_omega_block_table <- update_ztable(full_omega_block_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
print(full_omega_block_table)
```

###Box-Cox Transformation
```{r draw_boxcox_tranformation_table,echo=F,results='asis'}
boxcox_lambdas_table <- ztable(boxcox_lambdas_table)
boxcox_lambdas_table <- update_ztable(boxcox_lambdas_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
print(boxcox_lambdas_table)
```

#Covariates
```{r draw_covariates_table,echo=F,results='asis'}
covariates_extra_table <- ztable(covariates_extra_table)
covariates_extra_table <- update_ztable(covariates_extra_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
print(covariates_extra_table)
```

#Residual Error Model
```{r draw_resiual_error_model_table,echo=F,results='asis'}
resmod_ruv_models_table <- ztable(resmod_ruv_models_table)
resmod_ruv_models_table <- update_ztable(resmod_ruv_models_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
print(resmod_ruv_models_table)
```

#Influential Individuals
```{r draw_influential_individuals_table,echo=F,results='asis'}
if(cdd_files_exist) {
  if(nrow(ii_table) > cdd_max_rows) {
    ii_table <- ii_table[,1:cdd_max_rows]
  }
}

ii_table <- ztable(ii_table)
ii_table <- update_ztable(ii_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
print(ii_table)
```

#Outliers
```{r draw_outliers_table,echo=F,results='asis'}
outliers_table <- ztable(outliers_table)
outliers_table <- update_ztable(outliers_table,type=type,colnames.bold = T,include.rownames = F,longtable = T)
print(outliers_table)
```